<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CG Ranked — Player</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{--bg:#0b1420;--panel:#101b2a;--muted:#8aa0b8;--text:#e6f0ff;--accent:#2ea3ff;}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui}
nav{display:flex;gap:24px;align-items:center;padding:16px 24px;border-bottom:1px solid #1c2a3f;background:#0d1623}
nav .brand{font-weight:700}
.container{max-width:1100px;margin:24px auto;padding:0 16px}
.panel{background:var(--panel);border:1px solid #1b2940;border-radius:12px;padding:16px}
.grid{display:grid;grid-template-columns:1fr;gap:16px}
h1{margin:0 0 8px 0;font-size:22px}
.kpis{display:flex;gap:16px;flex-wrap:wrap}
.kpi{background:#0c1624;border:1px solid #1b2940;border-radius:12px;padding:12px 16px;min-width:120px}
.kpi .v{font-size:20px;font-weight:700}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1b2940;text-align:left}
th{color:#9fb6cf;font-weight:600}
</style>
</head>
<body>
<nav>
  <div class="brand">CG Ranked</div>
  <a href="/#/">Leaderboard</a>
</nav>

<div class="container grid">
  <section class="panel">
    <h1 id="title">Player</h1>
    <div class="kpis">
      <div class="kpi"><div class="t">Elo</div><div class="v" id="elo">–</div></div>
      <div class="kpi"><div class="t">RP</div><div class="v" id="rp">–</div></div>
      <div class="kpi"><div class="t">Games</div><div class="v" id="games">–</div></div>
      <div class="kpi"><div class="t">Win%</div><div class="v" id="winp">–</div></div>
    </div>
    <canvas id="eloChart" height="120"></canvas>
  </section>

  <section class="panel">
    <h1>Match history</h1>
    <table id="hist">
      <thead><tr><th>Date</th><th>Opponent</th><th>Result</th><th>Score</th><th>Map</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</div>

<script>
const SUPABASE_URL  = "https://REPLACE_WITH_YOURS.supabase.co";
const SUPABASE_ANON = "REPLACE_WITH_PUBLIC_ANON_KEY";
const headers = {"apikey": SUPABASE_ANON, "Authorization": "Bearer " + SUPABASE_ANON};

const params = new URLSearchParams(location.search);
const sid = params.get("sid");

function td(t){const e=document.createElement("td"); e.textContent=t; return e}
function esc(s){return (s??"").toString()}

async function fetchJSON(url){
  const r = await fetch(url, {headers});
  if(!r.ok) throw new Error(await r.text());
  return await r.json();
}

async function load(){
  const p = await fetchJSON(`${SUPABASE_URL}/rest/v1/players?select=*&steam_id=eq.${encodeURIComponent(sid)}`);
  const me = p[0];
  document.getElementById("title").textContent = (me?.username || sid) + " (" + sid + ")";
  document.getElementById("elo").textContent = esc(me?.elo ?? "–");
  document.getElementById("rp").textContent = esc(me?.rp ?? "–");
  const games = Number(me?.games_played||0), wins = Number(me?.wins||0);
  document.getElementById("games").textContent = games;
  document.getElementById("winp").textContent = games ? Math.round(100*wins/games)+"%" : "0%";

  const ratings = await fetchJSON(`${SUPABASE_URL}/rest/v1/ratings?select=at,elo_after&player_id=eq.${encodeURIComponent(sid)}&order=at.asc`);
  const labels = ratings.map(r => (r.at||"").replace("T"," ").split(".")[0]);
  const series = ratings.map(r => r.elo_after||0);
  const ctx = document.getElementById("eloChart").getContext("2d");
  new Chart(ctx, {
    type: 'line',
    data: {labels, datasets:[{label:"Elo", data:series}]},
    options: {responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}}}
  });

  // build history by joining matches where player is p1 or p2
  const histBody = document.querySelector("#hist tbody");
  histBody.innerHTML = "";
  const m1 = await fetchJSON(`${SUPABASE_URL}/rest/v1/matches?select=*&p1_id=eq.${encodeURIComponent(sid)}&order=played_at.desc&limit=100`);
  const m2 = await fetchJSON(`${SUPABASE_URL}/rest/v1/matches?select=*&p2_id=eq.${encodeURIComponent(sid)}&order=played_at.desc&limit=100`);
  const all = [...m1, ...m2].sort((a,b)=> (a.played_at<b.played_at?1:-1));
  all.forEach(m => {
    const tr = document.createElement("tr");
    const youAreP1 = m.p1_id===sid;
    const opp = youAreP1 ? m.p2_id : m.p1_id;
    const myScore = youAreP1 ? (m.p1_score||0) : (m.p2_score||0);
    const opScore = youAreP1 ? (m.p2_score||0) : (m.p1_score||0);
    const res = myScore>opScore ? "Win" : (myScore<opScore ? "Loss" : "Draw");
    tr.appendChild(td((m.played_at||"").replace("T"," ").split(".")[0]));
    tr.appendChild(td(opp));
    tr.appendChild(td(res));
    tr.appendChild(td(`${myScore}-${opScore}`));
    tr.appendChild(td(m.map_id||"-"));
    histBody.appendChild(tr);
  });
}

load();
</script>
</body>
</html>
