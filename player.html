<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Player</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-4">
    <a href="index.html" class="text-indigo-400 hover:underline">&larr; Back</a>

    <!-- HEADER REWORK -->
    <header id="header" class="mt-3"></header>

    <section class="mt-8 mb-8">
      <h2 class="text-xl font-semibold mb-2">Elo Timeline</h2>
      <div class="rounded border border-slate-800 p-3">
        <canvas id="eloChart" height="160"></canvas>
      </div>
    </section>

    <section>
      <h2 class="text-xl font-semibold mb-2">Recent matches</h2>
      <div id="matches" class="space-y-2"></div>
    </section>
  </div>

<script>
const SUPA_URL  = "https://yykwhpeczfapkileuxtb.supabase.co";
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3docGVjemZhcGtpbGV1eHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjM4NzUsImV4cCI6MjA3NzU5OTg3NX0.Sz2G1DG0CVYC9WSuYSODnH9k0_ybVluZAtRGBwb55wo";
const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

const url = new URL(location.href);
let steamId = url.searchParams.get('steam_id');
const q = url.searchParams.get('q');

const esc = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const fmtDate = iso => { try{const d=new Date(iso),p=n=>String(n).padStart(2,'0');return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`;}catch{return iso||'';} };
const fmtDur  = s => { if(s==null||isNaN(s)) return '—'; const m=Math.floor(s/60), sec=Math.floor(s%60); return `${m}:${String(sec).padStart(2,'0')}`; };
const fmtQ    = x => (x==null||isNaN(x)?'—':(Math.round(x*10)/10));

async function resolveQuery(){
  if(steamId) return steamId;
  if(!q) return null;
  const { data } = await supa.rpc('search_players',{ q, p_limit:1 });
  return (data && data.length) ? data[0].steam_id : null;
}

function chip(label, val){
  return `<div class="px-2 py-1 rounded-xl bg-slate-800/70 border border-slate-700 text-sm">
    <span class="text-slate-400">${label}</span>
    <span class="ml-1 text-slate-100 font-medium">${val}</span>
  </div>`;
}

function renderHeaderCard(p){
  const name = esc(p.username||p.steam_id);
  const avatarLetter = name.trim().charAt(0).toUpperCase() || '?';
  const perspectiveHref = `perspective.html?steam_id=${encodeURIComponent(p.steam_id)}`;

  return `
  <div class="p-4 rounded-2xl border border-slate-800 bg-slate-900/40">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-full bg-indigo-600/20 border border-indigo-500/30 grid place-items-center text-xl font-bold text-indigo-300">${avatarLetter}</div>
        <div>
          <div class="text-2xl font-extrabold leading-tight">${name}</div>
          <div class="mt-2 flex flex-wrap gap-2">
            ${chip('Rank', esc(p.rank||'—'))}
            ${chip('Elo', p.elo ?? '—')}
            ${chip('RP', p.rp ?? '—')}
            ${chip('Games', p.games ?? 0)}
            ${chip('Win%', p.win_rate ?? 0)}
          </div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <a class="px-3 py-2 rounded-xl bg-amber-500/20 text-amber-300 border border-amber-500/30 hover:bg-amber-500/30"
           href="${perspectiveHref}">Perspective</a>
        <button id="copyBtn" class="px-3 py-2 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700"
                title="Copy Steam ID">Copy ID</button>
      </div>
    </div>
  </div>`;
}

function ema(values, alpha){ const out=[]; let prev=null; for(const v of values){ if(v==null){out.push(prev);continue;} prev=prev==null?v:alpha*v+(1-alpha)*prev; out.push(prev);} return out; }

function drawElo(labels, values){
  const ctx = document.getElementById('eloChart').getContext('2d');
  const trend = ema(values, 0.2);
  new Chart(ctx,{
    type:'line',
    data:{ labels, datasets:[
      { label:'Elo', data: values, tension:0.25, pointRadius:0, borderWidth:2, borderColor:'#60a5fa' },
      { label:'Trend', data: trend, tension:0.25, pointRadius:0, borderWidth:2, borderColor:'#f59e0b' }
    ]},
    options:{
      plugins:{ legend:{ labels:{ color:'#cbd5e1' } }, tooltip:{ callbacks:{ title:()=>'' }}},
      scales:{ x:{ display:false, grid:{ display:false } }, y:{ ticks:{ color:'#94a3b8' }, grid:{ color:'rgba(148,163,184,0.15)' } } }
    }
  });
}

async function load(){
  steamId = await resolveQuery();
  if(!steamId){ document.getElementById('header').innerHTML='<div class="text-red-400">Player not found.</div>'; return; }

  const { data: player } = await supa.from('players').select('*').eq('steam_id',steamId).single();
  if(!player){ document.getElementById('header').innerHTML='<div class="text-red-400">Player not found.</div>'; return; }
  document.getElementById('header').innerHTML = renderHeaderCard(player);

  document.getElementById('copyBtn').onclick = async()=>{ await navigator.clipboard.writeText(steamId); };

  // Timeline
  let { data: rt } = await supa.from('ratings').select('at, elo_before, elo_after').eq('player_id', steamId).order('at', { ascending: true });
  if(!rt || rt.length < 2){
    const { data: mm } = await supa.from('matches')
      .select('played_at,p1_id,p2_id,p1_elo_before,p1_elo_after,p2_elo_before,p2_elo_after')
      .or(`p1_id.eq.${steamId},p2_id.eq.${steamId}`).order('played_at',{ascending:true}).limit(2000);
    rt = (mm||[]).map(m=>{
      const meIsP1 = m.p1_id===steamId;
      return { at:m.played_at, elo_before: meIsP1?m.p1_elo_before:m.p2_elo_before, elo_after: meIsP1?m.p1_elo_after:m.p2_elo_after };
    });
  }
  const labels = rt.map((_,i)=> i+1);
  const values = rt.map(x=> (x.elo_after ?? x.elo_before ?? null));
  drawElo(labels, values);

  // Matches + Quality
  const { data: matches } = await supa.from('matches')
    .select('id,played_at,p1_id,p2_id,p1_name,p2_name,winner,map_id,p1_elo_after,p2_elo_after,p1_elo_before,p2_elo_before')
    .or(`p1_id.eq.${steamId},p2_id.eq.${steamId}`).order('played_at',{ascending:false}).limit(50);

  const cont = document.getElementById('matches'); cont.innerHTML='';
  if(!matches || !matches.length) return;

  const ids = matches.map(m=>m.id);
  let aById = {};
  if(ids.length){
    const { data: analyses } = await supa.from('match_analyses').select('match_id,p1_quality,p2_quality,summary').in('match_id', ids);
    if(analyses){ for(const a of analyses) aById[a.match_id] = a; }
  }

  for(const m of matches){
    const a = aById[m.id] || {};
    const dur = a.summary?.duration_s;
    const meIsP1 = (m.p1_id === steamId);
    const winnerSide = (m.winner === 1 || m.winner === '1') ? 'p1' : (m.winner === 2 || m.winner === '2') ? 'p2' : null;

    const p1Elo = (m.p1_elo_after ?? m.p1_elo_before ?? '-');
    const p2Elo = (m.p2_elo_after ?? m.p2_elo_before ?? '-');

    const q1 = fmtQ(a.p1_quality);
    const q2 = fmtQ(a.p2_quality);

    const youBadge = `<span class="ml-2 px-1.5 py-0.5 text-[10px] rounded bg-indigo-600/20 text-indigo-300 border border-indigo-500/30 align-middle">you</span>`;
    const p1Name = esc(m.p1_name || m.p1_id || 'P1') + (meIsP1 ? youBadge : '');
    const p2Name = esc(m.p2_name || m.p2_id || 'P2') + (!meIsP1 ? youBadge : '');

    const winP1 = winnerSide==='p1' ? `<span class="ml-2 text-emerald-400 text-xs">Win</span>` : ``;
    const winP2 = winnerSide==='p2' ? `<span class="ml-2 text-emerald-400 text-xs">Win</span>` : ``;

    cont.innerHTML += `
      <a href="match.html?id=${m.id}" class="block rounded border border-slate-800 hover:border-indigo-500 bg-slate-900/40">
        <div class="px-3 py-2 border-b border-slate-800 text-slate-300 text-sm flex items-center justify-between">
          <div>${fmtDate(m.played_at)} · <span class="text-slate-400">Map ${m.map_id ?? '-'}</span></div>
          <div class="text-slate-400">Duration <span class="text-slate-100">${fmtDur(dur)}</span></div>
        </div>
        <div class="p-3 space-y-2">
          <div class="min-w-0 truncate">
            <span class="font-semibold">${p1Name}</span>
            <span class="text-slate-400">(${p1Elo})</span>
            <span class="ml-2 text-slate-400">· Quality <span class="text-slate-100">${q1}</span></span>
            ${winP1}
          </div>
          <div class="min-w-0 truncate">
            <span class="font-semibold">${p2Name}</span>
            <span class="text-slate-400">(${p2Elo})</span>
            <span class="ml-2 text-slate-400">· Quality <span class="text-slate-100">${q2}</span></span>
            ${winP2}
          </div>
        </div>
      </a>`;
  }
}
load();
</script>
</body>
</html>
