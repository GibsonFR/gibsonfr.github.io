<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CG Ranked ‚Äî Player</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1620;
      --panel:#111a27;
      --panel-2:#0d1520;
      --text:#e6eef8;
      --muted:#9db0c6;
      --accent:#6ee7ff;
      --accent-2:#42d392;
      --line:#1d2a3a;
      --danger:#ff5d5d;
      --yellow:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      background: radial-gradient(1200px 800px at 20% -10%, #132235 0%, #0f1620 60%);
      color: var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .nav{position:sticky;top:0;z-index:10;backdrop-filter:saturate(140%) blur(8px);background: rgba(9,14,22,.6);border-bottom:1px solid var(--line)}
    .nav-wrap{display:flex;gap:16px;align-items:center;max-width:1200px;margin:0 auto;padding:12px 24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-badge{width:28px;height:28px;display:grid;place-items:center;border-radius:6px;background:linear-gradient(135deg,#42d392 0%,#2dd4bf 50%,#06b6d4 100%);color:#08111b;font-weight:900}
    .btn{background:linear-gradient(180deg,#1a2a3b,#152233);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    .grid{display:grid;grid-template-columns: 1fr; gap:20px}
    .hero{background:linear-gradient(180deg,#111a27,#0d1520);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:18px}
    .kpis{display:grid;grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px;margin-top:10px}
    .kpi{background:#0f1826;border:1px solid var(--line);border-radius:12px;padding:12px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:24px;font-weight:700;margin-top:2px}
    .panel{background:linear-gradient(180deg,#111a27,#0d1520);border:1px solid var(--line);border-radius:14px}
    .panel h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--line);font-size:18px}
    .pad{padding:12px 14px}
    .muted{color:var(--muted)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:var(--muted);text-align:left;font-weight:600;background:#0f1826}
    tr:hover td{background:#0f1a28}
    .footer{opacity:.6;text-align:center;margin:24px 0 40px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <header class="nav">
    <div class="nav-wrap">
      <a class="brand" href="./index.html#leaderboard">
        <span class="brand-badge">CG</span> Ranked
      </a>
      <div style="margin-left:auto;">
        <button class="btn" onclick="history.back()">‚Üê Back</button>
      </div>
    </div>
  </header>

  <main class="container">
    <section class="hero">
      <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
        <div style="width:42px;height:42px;border-radius:10px;background:#0e1723;border:1px solid var(--line);display:grid;place-items:center">üë§</div>
        <div>
          <div id="playerName" style="font-size:22px;font-weight:700">Player</div>
          <div id="playerId" class="muted" style="font-size:12px">-</div>
        </div>
      </div>
      <div class="kpis">
        <div class="kpi"><div class="label">Elo</div><div class="value" id="kpiElo">-</div></div>
        <div class="kpi"><div class="label">RP</div><div class="value" id="kpiRP">-</div></div>
        <div class="kpi"><div class="label">Games</div><div class="value" id="kpiGames">-</div></div>
        <div class="kpi"><div class="label">Win%</div><div class="value" id="kpiWin">-</div></div>
      </div>
    </section>

    <section class="panel">
      <h3>Rating over time</h3>
      <div class="pad">
        <canvas id="eloChart" height="120"></canvas>
      </div>
    </section>

    <section class="panel">
      <h3>Match history</h3>
      <div style="overflow:auto;">
        <table>
          <thead>
            <tr>
              <th>Date</th><th>Opponent</th><th>Result</th><th>Score</th><th>Map</th>
            </tr>
          </thead>
          <tbody id="tbodyHistory"></tbody>
        </table>
      </div>
    </section>

    <p class="footer muted">UI inspired by chess.com ‚Ä¢ Built for Crab Game ranked.</p>
  </main>

<script>
// === CONFIG ‚Äî REMPLACE UNIQUEMENT CES 2 LIGNES ================================
const SUPABASE_URL  = "https://qnxjrkedbplfrlkjqifh.supabase.co"; // <= ton projet
const SUPABASE_ANON = "REPLACE_WITH_PUBLIC_ANON_KEY";             // <= ta cl√© anon
// ==============================================================================

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
const params = new URLSearchParams(location.search);
const SID = params.get('sid');

const fmtTime = (iso) => {
  if (!iso) return '-';
  try{
    const d = new Date(iso);
    return d.toLocaleString();
  }catch{ return iso; }
};
const pct = (w,g) => g>0 ? Math.round((w/g)*100) + '%' : '0%';

async function loadPlayer(){
  const { data, error } = await sb.from('players')
    .select('steam_id, username, rank, elo, rp, games_played, wins, last_active_at')
    .eq('steam_id', SID).maybeSingle();
  if (error || !data){
    document.getElementById('playerName').textContent = "Unknown player";
    document.getElementById('playerId').textContent = SID ?? "-";
    return;
  }
  document.getElementById('playerName').textContent = data.username ?? data.steam_id;
  document.getElementById('playerId').textContent   = data.steam_id;
  document.getElementById('kpiElo').textContent   = data.elo ?? '-';
  document.getElementById('kpiRP').textContent    = data.rp ?? '-';
  document.getElementById('kpiGames').textContent = data.games_played ?? 0;
  document.getElementById('kpiWin').textContent   = pct(data.wins ?? 0, data.games_played ?? 0);
}

async function loadElo(){
  const { data, error } = await sb.from('ratings')
    .select('at, elo_after')
    .eq('player_id', SID)
    .order('at', {ascending:true})
    .limit(300);
  const ctx = document.getElementById('eloChart');
  const labels = (data||[]).map(r => fmtTime(r.at));
  const vals   = (data||[]).map(r => r.elo_after || 0);
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets:[{ label:'Elo', data:vals, tension:.25 }]},
    options:{
      responsive:true,
      scales:{ x:{ticks:{color:'#9db0c6'}}, y:{ticks:{color:'#9db0c6'}}},
      plugins:{ legend:{display:false} }
    }
  });
}

async function loadHistory(){
  // r√©cup√®re les matchs o√π le joueur est p1 OU p2
  const q1 = sb.from('matches').select('played_at, p1_id, p2_id, p1_score, p2_score, map_id').eq('p1_id',SID);
  const q2 = sb.from('matches').select('played_at, p1_id, p2_id, p1_score, p2_score, map_id').eq('p2_id',SID);
  const [r1, r2] = await Promise.all([q1, q2]);
  const rows = [...(r1.data||[]), ...(r2.data||[])].sort((a,b)=> new Date(b.played_at) - new Date(a.played_at)).slice(0,200);

  const body = document.getElementById('tbodyHistory');
  body.innerHTML = "";
  rows.forEach(m => {
    const youAreP1 = m.p1_id === SID;
    const youScore = youAreP1 ? (m.p1_score||0) : (m.p2_score||0);
    const oppScore = youAreP1 ? (m.p2_score||0) : (m.p1_score||0);
    const oppId    = youAreP1 ? m.p2_id : m.p1_id;
    const res = youScore>oppScore ? 'Win' : (youScore<oppScore ? 'Loss' : 'Draw');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtTime(m.played_at)}</td>
      <td><a class="ok" href="./player.html?sid=${encodeURIComponent(oppId)}">${(oppId||'').slice(-6)}</a></td>
      <td>${res}</td>
      <td>${youScore}‚Äì${oppScore}</td>
      <td>${m.map_id ?? '-'}</td>
    `;
    body.appendChild(tr);
  });
}

if (!SID){
  alert("Missing sid parameter");
}else{
  loadPlayer();
  loadElo();
  loadHistory();
}
</script>
</body>
</html>
