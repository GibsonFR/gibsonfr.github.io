<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Perspective</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-4">
    <a href="index.html" class="text-indigo-400 hover:underline">&larr; Back</a>

    <!-- HEADER rework (même style que player.html) -->
    <header id="head" class="mt-3"></header>

    <!-- Actions -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
        <div class="flex flex-wrap items-center gap-3">
          <button id="buildBtn"
                  class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 border border-indigo-400/30">
            Build perspective
          </button>
          <span id="status" class="text-sm text-slate-400"></span>
        </div>
      </div>
      <div class="p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
        <form id="cmpForm" class="flex flex-wrap items-center gap-2" onsubmit="return false;">
          <label class="text-slate-300">Compare vs</label>
          <input id="cmpInput"
                 class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm"
                 placeholder="username ou SteamID64…">
          <button id="cmpBtn"
                  class="px-3 py-2 rounded-xl bg-amber-600 hover:bg-amber-500 border border-amber-400/30">
            Compare
          </button>
          <span id="cmpStatus" class="text-sm text-slate-400"></span>
        </form>
      </div>
    </div>

    <div id="content" class="mt-6"></div>
  </div>

<script>
const SUPA_URL  = "https://yykwhpeczfapkileuxtb.supabase.co";
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3docGVjemZhcGtpbGV1eHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjM4NzUsImV4cCI6MjA3NzU5OTg3NX0.Sz2G1DG0CVYC9WSuYSODnH9k0_ybVluZAtRGBwb55wo";
const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

const url = new URL(location.href);
const steamId = url.searchParams.get('steam_id');
const WINDOW_ALL = 0; // on calcule 100% des matchs

const esc = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pct = x => (x==null||isNaN(x) ? '—' : `${Math.round(x*1000)/10}%`);
const num = (x,d=1)=> (x==null||isNaN(x) ? '—' : (Math.round(x*Math.pow(10,d))/Math.pow(10,d)));

function chip(label, val){
  return `<div class="px-2 py-1 rounded-xl bg-slate-800/70 border border-slate-700 text-sm">
    <span class="text-slate-400">${label}</span>
    <span class="ml-1 text-slate-100 font-medium">${val}</span>
  </div>`;
}

function headerCard(p){
  const name = esc(p.username||p.steam_id);
  const avatar = (name.trim().charAt(0).toUpperCase()||'?');
  return `
  <div class="p-4 rounded-2xl border border-slate-800 bg-slate-900/40">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-full bg-indigo-600/20 border border-indigo-500/30 grid place-items-center text-xl font-bold text-indigo-300">${avatar}</div>
        <div>
          <div class="text-2xl font-extrabold leading-tight">${name}</div>
          <div id="chips" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
      </div>
      <div class="text-slate-400 text-sm">Perspective view</div>
    </div>
  </div>`;
}

function chipsFromSummary(s){
  return [
    chip('Matches', s.matches ?? 0),
    chip('Wins', s.wins ?? 0),
    chip('Win%', pct(s.winrate)),
    chip('Avg Quality', num(s.avg_quality,1)),
    chip('Median Quality', num(s.med_quality,1)),
    chip('Avg Duration', (s.avg_duration!=null? num(s.avg_duration,1)+'s':'—'))
  ].join('');
}

function table(title, cols, rows){
  return `
  <div class="mt-6">
    <h3 class="text-xl font-semibold mb-2">${title}</h3>
    <div class="overflow-x-auto rounded border border-slate-800">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900/60 text-slate-300">
          <tr>${cols.map(c=>`<th class="px-3 py-2 text-left">${c}</th>`).join('')}</tr>
        </thead>
        <tbody class="divide-y divide-slate-800">
          ${rows.map(r=>`<tr>${r.map(c=>`<td class="px-3 py-2 whitespace-nowrap">${c}</td>`).join('')}</tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
}

function renderPerspective(container, p){
  const s = p.summary||{};
  document.getElementById('chips').innerHTML = chipsFromSummary(s);

  let html = '';
  const mapRows = (p.maps||[]).map(m=>[
    `Map ${m.map_id}`, m.matches, pct(m.winrate), num(m.avg_quality,1), (m.avg_duration!=null? num(m.avg_duration,1)+'s':'—'), new Date(m.last_played).toLocaleDateString()
  ]);
  html += table('By Map', ['Map','Matches','Winrate','Avg Quality','Avg Duration','Last played'], mapRows);

  const eloRows = (p.elo_bands||[]).map(b=>[
    b.label, b.matches, pct(b.winrate), num(b.avg_quality,1)
  ]);
  html += table('Vs Opponent Elo bands', ['Band','Matches','Winrate','Avg Quality'], eloRows);

  const r = p.roles||{};
  const roleRows = [
    ['Tagger secs (avg)', num(r.tagger_seconds_avg,1)],
    ['Hider secs (avg)',  num(r.hider_seconds_avg,1)],
    ['Tagger quality (avg)', num(r.tagger_quality_avg,1)],
    ['Hider  quality (avg)', num(r.hider_quality_avg,1)],
  ];
  html += table('Roles', ['Metric','Value'], roleRows);

  const oppRows = (p.opponents||[]).slice(0,12).map(o=>[
    esc(o.name||o.id), o.matches, pct(o.winrate), num(o.avg_quality,1)
  ]);
  html += table('Most faced opponents', ['Opponent','Matches','Winrate','Avg Quality'], oppRows);

  container.innerHTML = html;
}

async function init(){
  const head = document.getElementById('head');
  const { data: player } = await supa.from('players').select('*').eq('steam_id', steamId).single();
  if(!player){ head.innerHTML='<div class="text-red-400">Player not found.</div>'; return; }
  head.innerHTML = headerCard(player);

  const content = document.getElementById('content');
  const status  = document.getElementById('status');

  async function loadPerspective(pid){
    const { data } = await supa.from('player_perspectives')
      .select('*')
      .eq('player_id', pid)
      .eq('window_size', WINDOW_ALL)   // 0 = 100% des matchs
      .maybeSingle();
    return data || null;
  }

  async function waitPerspective(pid, timeoutMs=60000){
    const t0 = Date.now();
    while (Date.now() - t0 < timeoutMs) {
      const p = await loadPerspective(pid);
      if (p) return p;
      await new Promise(r => setTimeout(r, 1500));
    }
    return null;
  }

  async function render(){
    const p = await loadPerspective(steamId);
    if(!p){
      content.innerHTML = `<div class="mt-6 text-slate-400">No perspective yet. Click “Build perspective”.</div>`;
    }else{
      renderPerspective(content, p);
    }
  }
  await render();

  // Build / Refresh
  document.getElementById('buildBtn').onclick = async()=>{
    status.textContent = 'Queuing…';
    const { error } = await supa.from('perspective_requests')
      .insert({ player_id: steamId, window_size: WINDOW_ALL, requested_by: 'web' });
    if (error) { status.textContent = `Insert failed: ${error.message}`; return; }
    status.textContent = 'Queued. Waiting for worker…';
    const p = await waitPerspective(steamId);
    if (p) { status.textContent = 'Ready ✓'; renderPerspective(content, p); }
    else   { status.textContent = 'Timeout while waiting for perspective.'; }
  };

  // Compare
  async function resolvePlayer(text){
    if(!text) return null;
    if(/^\d{5,}$/.test(text)) return text; // SteamID64
    const { data } = await supa.rpc('search_players',{ q: text, p_limit:1 });
    return (data&&data.length)? data[0].steam_id : null;
  }
  document.getElementById('cmpBtn').onclick = async()=>{
    const cmpStatus = document.getElementById('cmpStatus');
    const query = document.getElementById('cmpInput').value.trim();
    const other = await resolvePlayer(query);
    if(!other){ cmpStatus.textContent='Player not found.'; return; }

    // s’assurer que la perspective adverse existe
    let pb = await supa.from('player_perspectives').select('*')
      .eq('player_id', other).eq('window_size', WINDOW_ALL).maybeSingle();
    if(!pb.data){
      cmpStatus.textContent='Building opponent perspective…';
      await supa.from('perspective_requests')
        .insert({ player_id: other, window_size: WINDOW_ALL, requested_by: 'web' });
      pb = { data: await waitPerspective(other, 60000) };
      if(!pb.data){ cmpStatus.textContent='Timeout on opponent perspective.'; return; }
    }
    cmpStatus.textContent='';

    const pa = await loadPerspective(steamId);
    const wrap = document.createElement('div');
    wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
    const left  = document.createElement('div');
    const right = document.createElement('div');

    // titres clairs au-dessus
    left.innerHTML  = `<div class="mb-2 text-slate-300">${esc(player.username||player.steam_id)}</div>`;
    right.innerHTML = `<div class="mb-2 text-slate-300">${esc(pb.data.username||other)}</div>`;

    // conteneurs detail
    const lbox = document.createElement('div');
    const rbox = document.createElement('div');
    left.appendChild(lbox); right.appendChild(rbox);

    renderPerspective(lbox, pa);
    renderPerspective(rbox, pb.data);

    const content = document.getElementById('content');
    content.innerHTML = '';
    wrap.appendChild(left); wrap.appendChild(right);
    content.appendChild(wrap);
  };

  // Realtime pour re-render auto si activé
  supa.channel('persp_live')
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'player_perspectives', filter:`player_id=eq.${steamId}`}, render)
    .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'player_perspectives', filter:`player_id=eq.${steamId}`}, render)
    .subscribe();
}
init();
</script>
</body>
</html>
