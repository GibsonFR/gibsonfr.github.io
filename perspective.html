<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Perspective</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-4">
    <div id="authbar" class="mb-3"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4">
    <a href="index.html" class="text-indigo-400 hover:underline">&larr; Back</a>

    <!-- HEADER -->
    <header id="head" class="mt-3"></header>

    <!-- PREMIUM / AUTH GATE -->
    <div id="gateBanner" class="mt-4 p-4 rounded-2xl border border-slate-800 bg-slate-900/60 hidden"></div>

    <!-- Actions -->
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
        <div class="flex flex-wrap items-center gap-3">
          <button id="buildBtn"
                  class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 border border-indigo-400/30 disabled:opacity-50">
            Build perspective
          </button>
          <span id="status" class="text-sm text-slate-400"></span>
        </div>
      </div>
      <div class="p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
        <form id="cmpForm" class="flex flex-wrap items-center gap-2" onsubmit="return false;">
          <label class="text-slate-300">Compare vs</label>
          <input id="cmpInput"
                 class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm"
                 placeholder="username or SteamID64‚Ä¶">
          <button id="cmpBtn"
                  class="px-3 py-2 rounded-xl bg-amber-600 hover:bg-amber-500 border border-amber-400/30 disabled:opacity-50">
            Compare
          </button>
          <span id="cmpStatus" class="text-sm text-slate-400"></span>
        </form>
      </div>
    </div>

    <div id="content" class="mt-6"></div>
  </div>

<script>
const SUPA_URL  = "https://yykwhpeczfapkileuxtb.supabase.co";
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3docGVjemZhcGtpbGV1eHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjM4NzUsImV4cCI6MjA3NzU5OTg3NX0.Sz2G1DG0CVYC9WSuYSODnH9k0_ybVluZAtRGBwb55wo";
const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

const url = new URL(location.href);
const steamId = url.searchParams.get('steam_id');
const WINDOW_ALL = 0; // 0 = 100% of matches

const esc = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pct = x => (x==null||isNaN(x) ? '‚Äî' : `${Math.round(x*1000)/10}%`);
const num = (x,d=1)=> (x==null||isNaN(x) ? '‚Äî' : (Math.round(x*Math.pow(10,d))/Math.pow(10,d)));

function chip(label, val){
  return `<div class="px-2 py-1 rounded-xl bg-slate-800/70 border border-slate-700 text-sm">
    <span class="text-slate-400">${label}</span>
    <span class="ml-1 text-slate-100 font-medium">${val}</span>
  </div>`;
}

function headerCard(p){
  const name = esc(p.username||p.steam_id);
  const avatar = (name.trim().charAt(0).toUpperCase()||'?');
  return `
  <div class="p-4 rounded-2xl border border-slate-800 bg-slate-900/40">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 rounded-full bg-indigo-600/20 border border-indigo-500/30 grid place-items-center text-xl font-bold text-indigo-300">${avatar}</div>
        <div>
          <div class="text-2xl font-extrabold leading-tight">${name}</div>
          <div id="chips" class="mt-2 flex flex-wrap gap-2"></div>
        </div>
      </div>
      <div class="text-slate-400 text-sm">Perspective view</div>
    </div>
  </div>`;
}

function chipsFromSummary(s){
  return [
    chip('Matches', s.matches ?? 0),
    chip('Wins', s.wins ?? 0),
    chip('Win%', pct(s.winrate)),
    chip('Avg Quality', num(s.avg_quality,1)),
    chip('Median Quality', num(s.med_quality,1)),
    chip('Avg Duration', (s.avg_duration!=null? num(s.avg_duration,1)+'s':'‚Äî'))
  ].join('');
}

function table(title, cols, rows){
  return `
  <div class="mt-6">
    <h3 class="text-xl font-semibold mb-2">${title}</h3>
    <div class="overflow-x-auto rounded border border-slate-800">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-900/60 text-slate-300">
          <tr>${cols.map(c=>`<th class="px-3 py-2 text-left">${c}</th>`).join('')}</tr>
        </thead>
        <tbody class="divide-y divide-slate-800">
          ${rows.map(r=>`<tr>${r.map(c=>`<td class="px-3 py-2 whitespace-nowrap">${c}</td>`).join('')}</tr>`).join('')}
        </tbody>
      </table>
    </div>
  </div>`;
}

function renderPerspective(container, p){
  const s = p.summary||{};
  document.getElementById('chips').innerHTML = chipsFromSummary(s);

  let html = '';
  const mapRows = (p.maps||[]).map(m=>[
    `Map ${m.map_id}`, m.matches, pct(m.winrate), num(m.avg_quality,1), (m.avg_duration!=null? num(m.avg_duration,1)+'s':'‚Äî'), new Date(m.last_played).toLocaleDateString()
  ]);
  html += table('By Map', ['Map','Matches','Winrate','Avg Quality','Avg Duration','Last played'], mapRows);

  const eloRows = (p.elo_bands||[]).map(b=>[
    b.label, b.matches, pct(b.winrate), num(b.avg_quality,1)
  ]);
  html += table('Vs Opponent Elo bands', ['Band','Matches','Winrate','Avg Quality'], eloRows);

  const r = p.roles||{};
  const roleRows = [
    ['Tagger secs (avg)', num(r.tagger_seconds_avg,1)],
    ['Hider secs (avg)',  num(r.hider_seconds_avg,1)],
    ['Tagger quality (avg)', num(r.tagger_quality_avg,1)],
    ['Hider  quality (avg)', num(r.hider_quality_avg,1)],
  ];
  html += table('Roles', ['Metric','Value'], roleRows);

  const oppRows = (p.opponents||[]).slice(0,12).map(o=>[
    esc(o.name||o.id), o.matches, pct(o.winrate), num(o.avg_quality,1)
  ]);
  html += table('Most faced opponents', ['Opponent','Matches','Winrate','Avg Quality'], oppRows);

  container.innerHTML = html;
}

/* -------------------- PREMIUM GATE (auth + premium) -------------------- */

async function getUser() {
  const { data:{ user } } = await supa.auth.getUser();
  return user || null;
}

async function isPremium(user){
  try{
    const { data, error } = await supa
      .from('profiles')
      .select('premium_until')
      .eq('id', user.id)
      .maybeSingle();
    if (error) return false;
    return !!(data?.premium_until && new Date(data.premium_until) > new Date());
  } catch { return false; }
}

async function updateGateUI(){
  const gate = document.getElementById('gateBanner');
  const buildBtn = document.getElementById('buildBtn');
  const cmpBtn   = document.getElementById('cmpBtn');

  const user = await getUser();
  if (!user) {
    gate.classList.remove('hidden');
    gate.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="text-amber-300">üîí</div>
        <div>
          <div class="font-semibold mb-1">Sign in required</div>
          <div class="text-slate-300 text-sm">
            Perspective is a <b>Premium</b> feature. Please sign in with Discord to continue.
          </div>
          <div class="mt-2">
            <button id="signinBtn" class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm">Sign in with Discord</button>
          </div>
        </div>
      </div>`;
    if (buildBtn) buildBtn.disabled = true;
    if (cmpBtn)   cmpBtn.disabled   = true;

    const signinBtn = document.getElementById('signinBtn');
    if (signinBtn) {
      signinBtn.onclick = ()=> supa.auth.signInWithOAuth({
        provider: 'discord',
        options: { redirectTo: location.href }
      });
    }
    return { user:null, premium:false };
  }

  const premium = await isPremium(user);
  if (!premium) {
    gate.classList.remove('hidden');
    gate.innerHTML = `
      <div class="flex items-start gap-3">
        <div class="text-amber-300">üëë</div>
        <div>
          <div class="font-semibold mb-1">Premium only</div>
          <div class="text-slate-300 text-sm">
            Perspective is available for <b>Premium members</b> only. Upgrade to unlock unlimited analyses and Perspective.
          </div>
          <div class="mt-2 flex items-center gap-2">
            <a href="account.html" class="px-3 py-1.5 rounded bg-amber-500/20 text-amber-300 border border-amber-500/30 hover:bg-amber-500/30 text-sm">Go Premium (‚Ç¨2)</a>
            <button id="quickCheckout" class="px-3 py-1.5 rounded bg-amber-600/30 text-amber-200 border border-amber-500/40 hover:bg-amber-600/40 text-sm">Quick checkout</button>
          </div>
        </div>
      </div>`;
    if (buildBtn) buildBtn.disabled = true;
    if (cmpBtn)   cmpBtn.disabled   = true;

    const quick = document.getElementById('quickCheckout');
    if (quick) quick.onclick = (e)=>{ e.preventDefault(); if (window.startCheckout) window.startCheckout(); else location.href='account.html'; };

    return { user, premium:false };
  }

  // Premium OK
  gate.classList.add('hidden');
  if (buildBtn) buildBtn.disabled = false;
  if (cmpBtn)   cmpBtn.disabled   = false;
  return { user, premium:true };
}

/* -------------------- DATA LOAD -------------------- */

async function loadPerspective(pid){
  const { data } = await supa.from('player_perspectives')
    .select('*')
    .eq('player_id', pid)
    .eq('window_size', WINDOW_ALL)
    .maybeSingle();
  return data || null;
}

async function waitPerspective(pid, timeoutMs=60000){
  const t0 = Date.now();
  while (Date.now() - t0 < timeoutMs) {
    const p = await loadPerspective(pid);
    if (p) return p;
    await new Promise(r => setTimeout(r, 1500));
  }
  return null;
}

/* -------------------- INIT -------------------- */

async function init(){
  const head = document.getElementById('head');
  const status = document.getElementById('status');
  const content = document.getElementById('content');

  // Load player header
  const { data: player } = await supa.from('players').select('*').eq('steam_id', steamId).single();
  if(!player){ head.innerHTML='<div class="text-red-400">Player not found.</div>'; return; }
  head.innerHTML = headerCard(player);

  // Initial render (if perspective already exists)
  const existing = await loadPerspective(steamId);
  if(!existing){
    content.innerHTML = `<div class="mt-6 text-slate-400">No perspective yet. Click ‚ÄúBuild perspective‚Äù.</div>`;
  } else {
    renderPerspective(content, existing);
  }

  // Gate and button handlers
  let gateState = await updateGateUI();

  document.getElementById('buildBtn').onclick = async ()=>{
    gateState = await updateGateUI();
    if (!gateState.user || !gateState.premium) return;

    status.textContent = 'Queuing‚Ä¶';
    const { error } = await supa.from('perspective_requests')
      .insert({ player_id: steamId, window_size: WINDOW_ALL, requested_by: 'web' });
    if (error) { status.textContent = `Insert failed: ${error.message}`; return; }

    status.textContent = 'Queued. Waiting for worker‚Ä¶';
    const p = await waitPerspective(steamId);
    if (p) { status.textContent = 'Ready ‚úì'; renderPerspective(content, p); }
    else   { status.textContent = 'Timeout while waiting for perspective.'; }
  };

  async function resolvePlayer(text){
    if(!text) return null;
    if(/^\d{5,}$/.test(text)) return text; // SteamID64
    const { data } = await supa.rpc('search_players',{ q: text, p_limit:1 });
    return (data&&data.length)? data[0].steam_id : null;
  }

  document.getElementById('cmpBtn').onclick = async ()=>{
    gateState = await updateGateUI();
    if (!gateState.user || !gateState.premium) return;

    const cmpStatus = document.getElementById('cmpStatus');
    const query = document.getElementById('cmpInput').value.trim();
    const other = await resolvePlayer(query);
    if(!other){ cmpStatus.textContent='Player not found.'; return; }

    let pb = await supa.from('player_perspectives').select('*')
      .eq('player_id', other).eq('window_size', WINDOW_ALL).maybeSingle();
    if(!pb.data){
      cmpStatus.textContent='Building opponent perspective‚Ä¶';
      await supa.from('perspective_requests')
        .insert({ player_id: other, window_size: WINDOW_ALL, requested_by: 'web' });
      pb = { data: await waitPerspective(other, 60000) };
      if(!pb.data){ cmpStatus.textContent='Timeout on opponent perspective.'; return; }
    }
    cmpStatus.textContent='';

    const pa = await loadPerspective(steamId);
    const wrap = document.createElement('div');
    wrap.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
    const left  = document.createElement('div');
    const right = document.createElement('div');

    left.innerHTML  = `<div class="mb-2 text-slate-300">${esc(player.username||player.steam_id)}</div>`;
    right.innerHTML = `<div class="mb-2 text-slate-300">${esc(pb.data.username||other)}</div>`;

    const lbox = document.createElement('div');
    const rbox = document.createElement('div');
    left.appendChild(lbox); right.appendChild(rbox);

    renderPerspective(lbox, pa);
    renderPerspective(rbox, pb.data);

    content.innerHTML = '';
    wrap.appendChild(left); wrap.appendChild(right);
    content.appendChild(wrap);
  };

  // Realtime re-render
  supa.channel('persp_live')
    .on('postgres_changes',{ event:'INSERT', schema:'public', table:'player_perspectives', filter:`player_id=eq.${steamId}`}, async()=> {
      const p = await loadPerspective(steamId);
      if (p) renderPerspective(content, p);
    })
    .on('postgres_changes',{ event:'UPDATE', schema:'public', table:'player_perspectives', filter:`player_id=eq.${steamId}`}, async()=> {
      const p = await loadPerspective(steamId);
      if (p) renderPerspective(content, p);
    })
    .subscribe();

  // Refresh gate instantly on auth change
  supa.auth.onAuthStateChange(async () => {
    await updateGateUI();
  });
}
init();
</script>

<script src="auth.js"></script>
<script src="payments.js"></script>
</body>
</html>
