<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Perspective</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .reveal{opacity:0;transform:translateY(8px);transition:opacity .4s ease,transform .4s ease}
    .reveal.show{opacity:1;transform:translateY(0)}
    .tip{position:relative;cursor:help}
    .tip:after{
      content:attr(data-tip);position:absolute;left:50%;transform:translateX(-50%) translateY(8px);
      background:#0f172a;color:#e2e8f0;border:1px solid #334155;padding:.45rem .6rem;border-radius:.5rem;
      font-size:.75rem;line-height:1rem;white-space:pre-wrap;width:280px;max-width:80vw;pointer-events:none;
      opacity:0;transition:opacity .15s ease,transform .15s ease;z-index:30
    }
    .tip:hover:after{opacity:1;transform:translateX(-50%) translateY(6px)}
    .comp-grid{display:grid;grid-template-columns:1.3fr 1fr 1fr 1fr;gap:.5rem;align-items:center}
    .comp-grid .head{color:#9ca3af;font-size:.8rem}
    .cell{padding:.45rem .6rem;border-radius:.5rem;border:1px solid #334155;background:#0b1220}
    .delta-up{color:#34d399}.delta-down{color:#fb7185}
    .pill{padding:.35rem .7rem;border-radius:999px;border:1px solid #334155;background:#0b1220}
    .pill.active{background:rgba(245,158,11,.15);border-color:rgba(245,158,11,.35);color:#fbbf24}
    .bar {height:8px;border-radius:999px;background:linear-gradient(90deg,#fbbf24,#fde68a)}
    .bar-wrap{height:8px;border-radius:999px;background:#0b1220;border:1px solid #334155;overflow:hidden}
    .big-kpi{background:#0b1220;border:1px solid #334155;border-radius:1rem;padding:1rem}
    .big-val{font-weight:800;font-size:1.6rem}
    .crown svg{height:16px;width:16px;display:inline-block;vertical-align:-2px;color:#fcd34d}
  </style>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-6xl mx-auto p-4">
    <a class="text-indigo-400 hover:underline" href="index.html">&larr; Back</a>
  </div>

  <main class="max-w-6xl mx-auto p-4">
    <header id="head" class="reveal"></header>

    <!-- Controls -->
    <div class="mt-4 grid grid-cols-1 lg:grid-cols-2 gap-3">
      <div class="p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
        <div class="flex flex-wrap items-center gap-2">
          <label class="text-slate-300 text-sm">Comparison band</label>
          <select id="benchSelect" class="bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm">
            <option value="auto">Auto (by player)</option>
            <option value="global">Global (all players)</option>
            <option value="band:800">Elo 800â€“899</option>
            <option value="band:900">Elo 900â€“999</option>
            <option value="band:1000">Elo 1000â€“1099</option>
            <option value="band:1100">Elo 1100â€“1199</option>
            <option value="band:1200">Elo 1200â€“1299</option>
            <option value="band:1300">Elo 1300â€“1399</option>
            <option value="band:1400">Elo 1400â€“1499</option>
            <option value="band:1500">Elo 1500â€“1599</option>
            <option value="band:1600">Elo 1600â€“1699</option>
            <option value="band:1700">Elo 1700â€“1799</option>
            <option value="band:1800">Elo 1800â€“1899</option>
          </select>
          <label class="ml-2 text-xs text-slate-400 flex items-center gap-2">
            <input id="benchUseFilter" type="checkbox" class="accent-amber-500" checked>
            Apply current map to benchmarks
          </label>
          <span id="status" class="text-xs text-slate-400 ml-auto"></span>
        </div>
      </div>
      <div class="p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
        <form id="cmpForm" onsubmit="return false" class="flex flex-wrap items-center gap-2">
          <label class="text-slate-300 text-sm">Compare vs</label>
          <input id="cmpInput" class="flex-1 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-sm" placeholder="username or SteamID64â€¦">
          <button id="cmpBtn" class="px-3 py-2 rounded-xl bg-amber-600 hover:bg-amber-500 border border-amber-400/30 disabled:opacity-50">Compare (mirror)</button>
          <label class="ml-2 text-xs text-slate-400 flex items-center gap-2">
            <input id="cmpUseFilter" type="checkbox" class="accent-amber-500" checked>
            Apply current map
          </label>
        </form>
      </div>
    </div>

    <!-- Premium / auth gate -->
    <div id="gateBanner" class="mt-4 p-4 rounded-2xl border border-slate-800 bg-slate-900/60 hidden"></div>

    <!-- Map tabs -->
    <section class="mt-4 p-3 rounded-2xl border border-slate-800 bg-slate-900/40">
      <div class="flex flex-wrap items-center gap-2" id="mapTabs"></div>
      <div id="mapPanel" class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3"></div>
    </section>

    <!-- Overview chips -->
    <section id="chips" class="mt-4 grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3"></section>

    <!-- Sections -->
    <div id="content" class="mt-6"></div>
  </main>

<script>
/* ---------- Supabase ---------- */
const SUPA_URL  = "https://yykwhpeczfapkileuxtb.supabase.co";
const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3docGVjemZhcGtpbGV1eHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjM4NzUsImV4cCI6MjA3NzU5OTg3NX0.Sz2G1DG0CVYC9WSuYSODnH9k0_ybVluZAtRGBwb55wo";
const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

const url = new URL(location.href);
const steamId = url.searchParams.get('steam_id');

const MAP_NAMES = {35:'Mini Monke',36:'Small Beach',38:'Small Containers',39:'Tiny Town 2',40:'Tiny Town'};
const prettyMap = id => MAP_NAMES[id] ? `${id} â€” ${MAP_NAMES[id]}` : `Map ${id}`;

const esc = s => (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const pct = x => (x==null||isNaN(x) ? 'â€”' : `${Math.round(x*1000)/10}%`);
const num = (x,d=1)=> (x==null||isNaN(x) ? 'â€”' : (Math.round(x*Math.pow(10,d))/Math.pow(10,d)));
const fmtS = s => (s==null||isNaN(s)?'â€”':`${num(s,1)}s`);
function median(a){ a=(a||[]).filter(Number.isFinite).sort((x,y)=>x-y); if(!a.length) return null; const m=a.length/2; return a.length%2? a[(m|0)] : (a[m-1]+a[m])/2; }
function quantile(arr,q){ const a=(arr||[]).filter(Number.isFinite).sort((x,y)=>x-y); if(!a.length) return null; const pos=(a.length-1)*q, lo=Math.floor(pos), hi=Math.ceil(pos); return lo===hi ? a[lo] : a[lo]+(a[hi]-a[lo])*(pos-lo); }
function p90(a){ return quantile(a,.90); }
function p10(a){ return quantile(a,.10); }
function sum(a){ return (a||[]).reduce((t,x)=>t+(Number.isFinite(x)?x:0),0); }
function avg(a){ a=(a||[]).filter(Number.isFinite); return a.length? sum(a)/a.length : null; }
function std(a){ a=(a||[]).filter(Number.isFinite); if(!a.length) return null; const m=avg(a); return Math.sqrt(avg(a.map(x=>(x-m)*(x-m)))); }
function lastN(a,n){ return (a||[]).slice(Math.max(0,a.length-n)); }

function animateReveal(){ document.querySelectorAll('.reveal').forEach(x=>x.classList.add('show')); }

/* Premium cosmetics */
const crownSVG = `<span class="crown" title="Premium member" aria-label="Premium member">
  <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
    <path d="M5 19h14a1 1 0 0 0 1-1v-7.5l-3.8 2.85a1 1 0 0 1-1.52-.47L12 5.6l-2.68 7.28a1 1 0 0 1-1.52.47L4 10.5V18a1 1 0 0 0 1 1Zm-3 2a1 1 0 1 0 0 2h20a1 1 0 1 0 0-2H2Z"/>
  </svg>
</span>`;
function labelWithPremium(name, prem){ return prem ? `<span class="text-amber-300">${esc(name)}</span>${crownSVG}` : esc(name); }

/* ---------- Auth & premium ---------- */
async function getUser(){ const { data:{ user } } = await supa.auth.getUser(); return user||null; }
async function isPremiumUser(user){
  try{ const { data } = await supa.from('profiles').select('premium_until').eq('id', user.id).maybeSingle();
    return !!(data?.premium_until && new Date(data.premium_until) > new Date());
  }catch{ return false; }
}
async function isPremiumSteam(sid){
  try{
    const nowIso = new Date().toISOString();
    const { data } = await supa.from('profiles').select('steam_id').eq('steam_id', sid).gt('premium_until', nowIso).maybeSingle();
    return !!data;
  }catch{ return false; }
}

async function updateGateUI(){
  const gate = document.getElementById('gateBanner');
  const cmpBtn = document.getElementById('cmpBtn');
  const user = await getUser();
  if (!user){
    gate.classList.remove('hidden');
    gate.innerHTML = `<div class="flex items-start gap-3">
      <div class="text-amber-300">ðŸ”’</div>
      <div>
        <div class="font-semibold mb-1">Sign in required</div>
        <div class="text-slate-300 text-sm">Perspective is a <b>Premium</b> feature. Sign in with Discord to continue.</div>
        <div class="mt-2"><button class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm" id="signinBtn">Sign in with Discord</button></div>
      </div>
    </div>`;
    cmpBtn.disabled = true;
    document.getElementById('signinBtn').onclick = ()=> supa.auth.signInWithOAuth({ provider:'discord', options:{ redirectTo: location.href }});
    return {user:null,premium:false};
  }
  const premium = await isPremiumUser(user);
  if (!premium){
    gate.classList.remove('hidden');
    gate.innerHTML = `<div class="flex items-start gap-3">
      <div class="text-amber-300">ðŸ‘‘</div>
      <div>
        <div class="font-semibold mb-1">Premium only</div>
        <div class="text-slate-300 text-sm">Perspective is available for <b>Premium members</b> only. Upgrade to unlock unlimited analyses and Perspective.</div>
        <div class="mt-2 flex items-center gap-2">
          <a href="account.html" class="px-3 py-1.5 rounded bg-amber-500/20 text-amber-300 border border-amber-500/30 hover:bg-amber-500/30 text-sm">Go Premium (â‚¬2)</a>
        </div>
      </div>
    </div>`;
    cmpBtn.disabled = true;
    return {user, premium:false};
  }
  gate.classList.add('hidden'); cmpBtn.disabled=false;
  return {user, premium:true};
}

/* ---------- Data fetch ---------- */
async function fetchPlayer(){ const { data } = await supa.from('players').select('*').eq('steam_id', steamId).maybeSingle(); return data||null; }
async function fetchMatchesForPlayer(sid, limit=800){
  const { data } = await supa.from('matches')
    .select('id, played_at, map_id, winner, p1_id, p2_id, p1_name, p2_name, p1_elo_before, p1_elo_after, p2_elo_before, p2_elo_after')
    .or(`p1_id.eq.${sid},p2_id.eq.${sid}`).order('played_at',{ascending:true}).limit(limit);
  return data||[];
}
async function fetchAnalysesFor(ids){
  if(!ids.length) return new Map();
  const { data } = await supa.from('match_analyses')
    .select('match_id, p1_quality, p2_quality, p1_stats, p2_stats').in('match_id', ids);
  const m=new Map(); (data||[]).forEach(r=>m.set(r.match_id,r)); return m;
}

/* ---------- Aggregation ---------- */
function aggregateMetricsForPlayer(sid, matches, analyses, mapId=null){
  const scope = mapId ? matches.filter(m=> String(m.map_id)===String(mapId)) : matches.slice();
  const eloSeries=[], results=[], qual=[], speeds=[], distH=[], distT=[], tagShare=[], tagSecs=[], hidSecs=[], retMed=[], retAvg=[], acc=[];
  const byMap = new Map();

  for(const m of scope){
    const side = (String(m.p1_id)===String(sid)) ? 'p1' : 'p2';
    const win  = (m.winner===1||m.winner==='1') ? (side==='p1') : (m.winner===2||m.winner==='2') ? (side==='p2') : null;
    if (win!=null) results.push(!!win);
    const elo = (side==='p1') ? (m.p1_elo_after ?? m.p1_elo_before) : (m.p2_elo_after ?? m.p2_elo_before);
    if (elo!=null) eloSeries.push(Number(elo));

    const a=analyses.get(m.id);
    if(a){
      const s=(side==='p1')? (a.p1_stats||{}) : (a.p2_stats||{});
      const q=(side==='p1')? a.p1_quality : a.p2_quality;
      if (isFinite(q)) qual.push(Number(q));
      const ts=Number(s.seconds_as_tagger), hs=Number(s.seconds_as_hider);
      if (isFinite(ts) && isFinite(hs) && (ts+hs)>0) tagShare.push(ts/(ts+hs));
      else if (isFinite(s.time_as_tagger_share)) tagShare.push(Number(s.time_as_tagger_share));
      if (isFinite(ts)) tagSecs.push(ts);
      if (isFinite(hs)) hidSecs.push(hs);
      if (isFinite(s.avg_speed_ms)) speeds.push(Number(s.avg_speed_ms));
      if (isFinite(s.avg_distance_as_hider))  distH.push(Number(s.avg_distance_as_hider));
      if (isFinite(s.avg_distance_as_tagger)) distT.push(Number(s.avg_distance_as_tagger));
      if (isFinite(s.retag_median_seconds))    retMed.push(Number(s.retag_median_seconds));
      if (isFinite(s.retag_avg_seconds))       retAvg.push(Number(s.retag_avg_seconds));
      if (isFinite(s.accuracy))                acc.push(Number(s.accuracy));
    }

    const key=String(m.map_id);
    if(!byMap.has(key)) byMap.set(key,{map_id:m.map_id,matches:0,wins:0,q:[],sp:[],ts:[],rm:[]});
    const bm=byMap.get(key); bm.matches++; if (win) bm.wins++;
    if(a){
      const s2=(side==='p1')? (a.p1_stats||{}) : (a.p2_stats||{});
      const q2=(side==='p1')? a.p1_quality : a.p2_quality;
      if (isFinite(q2)) bm.q.push(Number(q2));
      if (isFinite(s2.avg_speed_ms)) bm.sp.push(Number(s2.avg_speed_ms));
      const ts2=Number(s2.seconds_as_tagger), hs2=Number(s2.seconds_as_hider);
      if (isFinite(ts2) && isFinite(hs2) && (ts2+hs2)>0) bm.ts.push(ts2/(ts2+hs2));
      else if (isFinite(s2.time_as_tagger_share)) bm.ts.push(Number(s2.time_as_tagger_share));
      if (isFinite(s2.retag_median_seconds)) bm.rm.push(Number(s2.retag_median_seconds));
    }
  }

  const count=scope.length, wins=results.filter(Boolean).length, winrate=count? wins/count : null;
  const metrics={
    scopeCount:count, wins, winrate,
    quality:{ average:avg(qual), median:median(qual), spread_iqr:(quantile(qual,.75)-quantile(qual,.25)), spread_std:std(qual), best_match:qual.length?Math.max(...qual):null, worst_match:qual.length?Math.min(...qual):null },
    tagging:{ share_as_tagger:avg(tagShare), time_as_tagger_average:avg(tagSecs), time_as_hider_average:avg(hidSecs) },
    speed:{ average_mps:avg(speeds), p90_mps:p90(speeds) },
    distance:{ average_hider_m:avg(distH), average_tagger_m:avg(distT) },
    retag:{ median_seconds:median(retMed), average_seconds:avg(retAvg), p90_seconds:p90(retMed) },
    accuracy:{ average:avg(acc) },
    eloSeries, maps:[...byMap.values()].sort((a,b)=>a.map_id-b.map_id)
  };
  return metrics;
}

function aggregateDataset(matches, analyses, mapId=null){
  const scope = mapId ? matches.filter(m=> String(m.map_id)===String(mapId)) : matches.slice();
  const qual=[], speeds=[], distH=[], distT=[], tagShare=[], tagSecs=[], hidSecs=[], retMed=[], retAvg=[], acc=[];
  for(const m of scope){
    const a=analyses.get(m.id); if(!a) continue;
    for(const s of [a.p1_stats||{}, a.p2_stats||{}]){
      const ts=Number(s.seconds_as_tagger), hs=Number(s.seconds_as_hider);
      if (isFinite(ts) && isFinite(hs) && (ts+hs)>0) tagShare.push(ts/(ts+hs));
      else if (isFinite(s.time_as_tagger_share)) tagShare.push(Number(s.time_as_tagger_share));
      if (isFinite(ts)) tagSecs.push(ts);
      if (isFinite(hs)) hidSecs.push(hs);
      if (isFinite(s.avg_speed_ms)) speeds.push(Number(s.avg_speed_ms));
      if (isFinite(s.avg_distance_as_hider))  distH.push(Number(s.avg_distance_as_hider));
      if (isFinite(s.avg_distance_as_tagger)) distT.push(Number(s.avg_distance_as_tagger));
      if (isFinite(s.retag_median_seconds))    retMed.push(Number(s.retag_median_seconds));
      if (isFinite(s.retag_avg_seconds))       retAvg.push(Number(s.retag_avg_seconds));
      if (isFinite(s.accuracy))                acc.push(Number(s.accuracy));
    }
    if (isFinite(a.p1_quality)) qual.push(Number(a.p1_quality));
    if (isFinite(a.p2_quality)) qual.push(Number(a.p2_quality));
  }
  return {
    quality:{average:avg(qual)},
    tagging:{share_as_tagger:avg(tagShare), time_as_tagger_average:avg(tagSecs), time_as_hider_average:avg(hidSecs)},
    speed:{average_mps:avg(speeds), p90_mps:p90(speeds)},
    distance:{average_hider_m:avg(distH), average_tagger_m:avg(distT)},
    retag:{median_seconds:median(retMed), average_seconds:avg(retAvg), p90_seconds:p90(retMed)},
    accuracy:{average:avg(acc)}
  };
}

/* ---------- Benchmarks ---------- */
let benchMode='auto'; // auto | global | band:####

function bandOfElo(e){ return Math.floor(Number(e||0)/100)*100; }
function eloOf(m,s){ return s==='p1'? (m.p1_elo_after ?? m.p1_elo_before) : (m.p2_elo_after ?? m.p2_elo_before); }
function playerAutoBand(matches){
  const elos=[];
  for(const m of matches){
    const side = String(m.p1_id)===String(steamId) ? 'p1' : (String(m.p2_id)===String(steamId)?'p2':null);
    if(!side) continue;
    const e = eloOf(m,side); if(isFinite(e)) elos.push(Number(e));
  }
  return bandOfElo(median(elos)||1200);
}

async function fetchBenchmarkBand(min,max,limit=2000){
  const orCond =
    `and(p1_elo_before.gte.${min},p1_elo_before.lt.${max}),`+
    `and(p2_elo_before.gte.${min},p2_elo_before.lt.${max}),`+
    `and(p1_elo_after.gte.${min},p1_elo_after.lt.${max}),`+
    `and(p2_elo_after.gte.${min},p2_elo_after.lt.${max})`;
  const { data:m } = await supa.from('matches')
    .select('id,map_id,winner,p1_id,p2_id,p1_elo_before,p1_elo_after,p2_elo_before,p2_elo_after')
    .or(orCond).order('played_at',{ascending:false}).limit(limit);
  const ids=(m||[]).map(x=>x.id); const a=await fetchAnalysesFor(ids);
  return {matches:m||[], analyses:a};
}
async function fetchBenchmarkGlobal(limit=2000){
  const { data:m } = await supa.from('matches')
    .select('id,map_id,winner,p1_id,p2_id,p1_elo_before,p1_elo_after,p2_elo_before,p2_elo_after')
    .order('played_at',{ascending:false}).limit(limit);
  const ids=(m||[]).map(x=>x.id); const a=await fetchAnalysesFor(ids);
  return {matches:m||[], analyses:a};
}

/* ---------- UI helpers ---------- */
function chip(label, val, tip, suffix=''){
  return `<div class="reveal cell">
    <div class="text-slate-400 text-xs tip" data-tip="${esc(tip)}">${label}</div>
    <div class="mt-1 font-semibold">${val}${suffix}</div>
  </div>`;
}
function delta(a,b,suffix=''){
  if(!isFinite(a)||!isFinite(b)) return '';
  const d=Math.round((a-b)*100)/100;
  if(d===0) return `<span class="text-slate-400 text-xs">Â±0${suffix}</span>`;
  const up=d>0; return `<span class="${up?'delta-up':'delta-down'} text-xs">${up?'â–²':'â–¼'} ${Math.abs(d)}${suffix}</span>`;
}
function compRow(label,tip,you,band,glob,fmt=(x)=>x,suffix=''){
  const Y=fmt(you), B=fmt(band), G=fmt(glob);
  return `<div class="contents">
    <div class="tip head" data-tip="${esc(tip)}">${label}</div>
    <div class="cell font-semibold">${Y}${suffix}</div>
    <div class="cell">${B}${suffix} ${delta(you,band,suffix)}</div>
    <div class="cell">${G}${suffix} ${delta(you,glob,suffix)}</div>
  </div>`;
}
function compSection(title, rowsHTML){
  return `<section class="mt-4 p-4 rounded-2xl border border-slate-800 bg-slate-900/40 reveal">
    <h3 class="text-lg font-semibold mb-2">${title}</h3>
    <div class="comp-grid">
      <div></div><div class="head">You</div><div class="head">Band</div><div class="head">Global</div>
      ${rowsHTML}
    </div>
  </section>`;
}
function mapTabButton(id,label,active){
  return `<button class="pill ${active?'active':''}" data-map="${id??''}">${label}</button>`;
}
function setBar(widthPct){
  return `<div class="bar-wrap"><div class="bar" style="width:${Math.max(0,Math.min(100,widthPct))}%"></div></div>`;
}

/* ---------- Render ---------- */
let playerRow=null, isPremSteamFlag=false, matchesCache=[], analysesCache=new Map(), currentMap=null;
let benchGlobal=null, benchBand=null;

async function renderHeader(){
  isPremSteamFlag = await isPremiumSteam(steamId);
  const name = playerRow?.username || steamId;
  document.getElementById('head').innerHTML =
    `<div class="p-4 rounded-2xl border border-slate-800 bg-slate-900/40">
      <div class="flex items-center gap-3">
        <div class="w-12 h-12 rounded-full bg-indigo-600/20 border border-indigo-500/30 grid place-items-center text-lg font-bold text-indigo-300">
          ${(name||'?').trim().charAt(0).toUpperCase()}
        </div>
        <div class="text-2xl font-extrabold">${labelWithPremium(name, isPremSteamFlag)}</div>
      </div>
    </div>`;
}

function renderMapTabs(){
  const tabsEl = document.getElementById('mapTabs');
  const mapIds = [...new Set(matchesCache.map(m=>m.map_id))].sort((a,b)=>a-b);
  tabsEl.innerHTML = [
    mapTabButton('', 'All', currentMap==null),
    ...mapIds.map(id=> mapTabButton(id, MAP_NAMES[id]||`Map ${id}`, String(currentMap)===String(id)))
  ].join('');
  tabsEl.querySelectorAll('button[data-map]').forEach(b=>{
    b.onclick = ()=>{ currentMap = (b.dataset.map===''? null : b.dataset.map); recompute(); };
  });
}

function renderMapPanel(metrics){
  const panel = document.getElementById('mapPanel');
  const wr = metrics.winrate!=null ? Math.round(metrics.winrate*1000)/10 : null;
  panel.innerHTML = `
    <div class="big-kpi">
      <div class="text-slate-400 text-xs">Win rate</div>
      <div class="big-val">${wr==null?'â€”':wr+'%'}
        ${wr==null?'':setBar(wr)}
      </div>
    </div>
    <div class="big-kpi">
      <div class="text-slate-400 text-xs">Average quality</div>
      <div class="big-val">${num(metrics.quality.average,1)}</div>
    </div>
    <div class="big-kpi">
      <div class="text-slate-400 text-xs">Tag time share</div>
      <div class="big-val">${metrics.tagging.share_as_tagger!=null? pct(metrics.tagging.share_as_tagger):'â€”'}</div>
    </div>
    <div class="big-kpi">
      <div class="text-slate-400 text-xs">Average speed</div>
      <div class="big-val">${num(metrics.speed.average_mps,2)} <span class="text-base font-semibold">m/s</span></div>
    </div>
    <div class="big-kpi">
      <div class="text-slate-400 text-xs">Retag median</div>
      <div class="big-val">${fmtS(metrics.retag.median_seconds)}</div>
    </div>
    <div class="big-kpi">
      <div class="text-slate-400 text-xs">Accuracy</div>
      <div class="big-val">${metrics.accuracy.average!=null? pct(metrics.accuracy.average):'â€”'}</div>
    </div>`;
}

function renderChips(metrics){
  const el=document.getElementById('chips');
  el.innerHTML = [
    chip('Matches played', metrics.scopeCount||0, 'Number of matches in current tab.'),
    chip('Wins', metrics.wins||0, 'Number of wins in current tab.'),
    chip('Win rate', metrics.winrate!=null? Math.round(metrics.winrate*1000)/10+'%':'â€”', 'Percentage of wins.'),
    chip('Average quality', num(metrics.quality.average,1), 'Average quality score.'),
    chip('Median quality', num(metrics.quality.median,1), 'Median quality score.'),
    chip('Quality IQR', num(metrics.quality.spread_iqr,1), 'Interquartile range (Q3â€“Q1). Lower means more consistency.'),
    chip('Quality std. dev.', num(metrics.quality.spread_std,2), 'Standard deviation of quality.'),
    chip('Best match quality', num(metrics.quality.best_match,1), 'Best quality score observed.')
  ].join('');
}

function compBlocks(metrics, band, glob){
  const r=[];
  // Tagging
  r.push(compSection('Tagging profile',
    compRow('Share of time as tagger','Share of total time spent as the tagger.',
      (metrics.tagging.share_as_tagger??null)*100,(band?.tagging?.share_as_tagger??null)*100,(glob?.tagging?.share_as_tagger??null)*100,
      x=> isFinite(x)? (Math.round(x*10)/10)+'%':'â€”','%')
    +
    compRow('Average time as tagger (s)','Average number of seconds spent as the tagger per match.',
      metrics.tagging.time_as_tagger_average,band?.tagging?.time_as_tagger_average,glob?.tagging?.time_as_tagger_average,
      x=> num(x,1),'s')
    +
    compRow('Average time as hider (s)','Average number of seconds spent as the hider per match.',
      metrics.tagging.time_as_hider_average,band?.tagging?.time_as_hider_average,glob?.tagging?.time_as_hider_average,
      x=> num(x,1),'s')
  ));

  // Speed & distance
  r.push(compSection('Speed and distance',
    compRow('Average speed (m/s)','Average movement speed.',
      metrics.speed.average_mps,band?.speed?.average_mps,glob?.speed?.average_mps, x=> num(x,2))
    +
    compRow('Hider distance (m)','Average distance traveled while hiding.',
      metrics.distance.average_hider_m,band?.distance?.average_hider_m,glob?.distance?.average_hider_m,x=> num(x,2))
    +
    compRow('Tagger distance (m)','Average distance traveled while tagging.',
      metrics.distance.average_tagger_m,band?.distance?.average_tagger_m,glob?.distance?.average_tagger_m,x=> num(x,2))
  ));

  // Retag & accuracy
  r.push(compSection('Retagging and accuracy',
    compRow('Retag median (s)','Typical time between consecutive tags.',
      metrics.retag.median_seconds,band?.retag?.median_seconds,glob?.retag?.median_seconds,x=> num(x,1),'s')
    +
    compRow('Retag average (s)','Average time between tags.',
      metrics.retag.average_seconds,band?.retag?.average_seconds,glob?.retag?.average_seconds,x=> num(x,1),'s')
    +
    compRow('Accuracy (%)','Share of successful attempts.',
      (metrics.accuracy.average??null)*100,(band?.accuracy?.average??null)*100,(glob?.accuracy?.average??null)*100,
      x=> isFinite(x)? (Math.round(x*10)/10):'â€”','%')
  ));
  return r.join('');
}

async function recompute(){
  const status = document.getElementById('status');
  status.textContent='Computingâ€¦';

  // Player metrics
  const metrics = aggregateMetricsForPlayer(steamId, matchesCache, analysesCache, currentMap);
  renderMapPanel(metrics);
  renderChips(metrics);

  // Bench sources
  const useFilter = document.getElementById('benchUseFilter').checked;
  let bandMetrics=null, globalMetrics=null;

  if (!benchGlobal){
    const g = await fetchBenchmarkGlobal(2000);
    benchGlobal = aggregateDataset(g.matches, g.analyses, useFilter? currentMap : null);
  } else {
    // already computed; for map change we simply re-fetch to respect filter
    const g = await fetchBenchmarkGlobal(1200);
    benchGlobal = aggregateDataset(g.matches, g.analyses, useFilter? currentMap : null);
  }

  if (benchMode==='auto'){
    const bmin = playerAutoBand(matchesCache);
    const pack = await fetchBenchmarkBand(bmin, bmin+100, 1500);
    bandMetrics = aggregateDataset(pack.matches, pack.analyses, useFilter? currentMap : null);
  } else if (benchMode==='global'){
    bandMetrics = null; // will display only Global
  } else if (benchMode.startsWith('band:')){
    const bmin = Number(benchMode.split(':')[1]);
    const pack = await fetchBenchmarkBand(bmin, bmin+100, 1500);
    bandMetrics = aggregateDataset(pack.matches, pack.analyses, useFilter? currentMap : null);
  }

  // Sections
  document.getElementById('content').innerHTML = compBlocks(metrics, bandMetrics, benchGlobal);

  animateReveal();
  status.textContent='';
}

/* ---------- Compare (mirror) ---------- */
async function resolvePlayer(q){
  if(!q) return null;
  if(/^\d{5,}$/.test(q)) return q;
  try{ const { data } = await supa.rpc('search_players',{ q, p_limit:1 }); if(data?.length) return data[0].steam_id; }catch{}
  const { data:d2 } = await supa.from('players').select('steam_id,username').ilike('username', `%${q}%`).limit(1);
  return d2?.[0]?.steam_id || null;
}
document.getElementById('cmpBtn').onclick = async ()=>{
  const user = await getUser(); const prem = user && await isPremiumUser(user);
  if(!prem) return;

  const query = document.getElementById('cmpInput').value.trim();
  const applyFilter = document.getElementById('cmpUseFilter').checked;
  const other = await resolvePlayer(query); if(!other) { document.getElementById('status').textContent='Player not found'; return; }

  const mA = aggregateMetricsForPlayer(steamId, matchesCache, analysesCache, applyFilter? currentMap : null);

  const mBlist = await fetchMatchesForPlayer(other, 800);
  const aBmap  = await fetchAnalysesFor(mBlist.map(m=>m.id));
  const mB = aggregateMetricsForPlayer(other, mBlist, aBmap, applyFilter? currentMap : null);

  const { data:pb } = await supa.from('players').select('username').eq('steam_id', other).maybeSingle();
  const nameB = pb?.username || other;
  const premA = await isPremiumSteam(steamId);
  const premB = await isPremiumSteam(other);

  const mirror = document.createElement('section');
  mirror.className='mt-4 p-4 rounded-2xl border border-slate-800 bg-slate-900/40 reveal';
  mirror.innerHTML = `
    <h3 class="text-lg font-semibold mb-2">Mirror view</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <div class="cell"><div class="font-semibold">${labelWithPremium(playerRow?.username||steamId, premA)}</div>
        <div class="text-slate-300 text-sm mt-1">Win rate <b>${mA.winrate!=null? Math.round(mA.winrate*1000)/10+'%':'â€”'}</b> Â· Avg quality <b>${num(mA.quality.average,1)}</b></div>
      </div>
      <div class="cell"><div class="font-semibold">${labelWithPremium(nameB, premB)}</div>
        <div class="text-slate-300 text-sm mt-1">Win rate <b>${mB.winrate!=null? Math.round(mB.winrate*1000)/10+'%':'â€”'}</b> Â· Avg quality <b>${num(mB.quality.average,1)}</b></div>
      </div>
    </div>`;
  document.getElementById('content').prepend(mirror);
  animateReveal();
};

/* ---------- Init ---------- */
async function init(){
  playerRow = await fetchPlayer();
  await renderHeader();

  const gate = await updateGateUI();
  supa.auth.onAuthStateChange(updateGateUI);

  matchesCache = await fetchMatchesForPlayer(steamId, 800);
  analysesCache = await fetchAnalysesFor(matchesCache.map(m=>m.id));

  renderMapTabs();
  await recompute();

  document.getElementById('benchSelect').addEventListener('change', e=>{
    benchMode = e.target.value; recompute();
  });
  document.getElementById('benchUseFilter').addEventListener('change', ()=>recompute());
}
init();
</script>

<script src="auth.js"></script>
<script src="payments.js"></script>
</body>
</html>
