<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Account — Ranked Tag</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Set your public Supabase values (or define them globally) -->
  <script>
    window.SUPA_URL  = window.SUPA_URL  || "https://YOUR_SUPABASE_URL.supabase.co";
    window.SUPA_ANON = window.SUPA_ANON || "YOUR_SUPABASE_ANON_KEY";

    // PayPal keys (optional). For subscriptions you need a live PLAN_ID created in PayPal.
    window.PAYPAL_CLIENT_ID = window.PAYPAL_CLIENT_ID || "YOUR_PAYPAL_CLIENT_ID";
    window.PAYPAL_PLAN_ID   = window.PAYPAL_PLAN_ID   || "P-XXXXXXXXXXXX"; // €2/month plan id
    window.ONE_TIME_PRICE_EUR = window.ONE_TIME_PRICE_EUR || "2.00";        // 30-day pass
  </script>
</head>
<body class="bg-slate-950 text-slate-100">
  <div class="max-w-4xl mx-auto p-4">
    <div id="authbar" class="mb-3"></div>
    <a href="index.html" class="text-indigo-400 hover:underline">&larr; Back to leaderboard</a>

    <div class="mt-4 p-4 rounded-2xl border border-slate-800 bg-slate-900/40">
      <h1 class="text-2xl font-bold mb-1">Account</h1>
      <div id="accStatus" class="text-slate-300">Loading…</div>
    </div>

    <div class="mt-6">
      <div class="flex gap-2 border-b border-slate-800">
        <button data-tab="profile" class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-slate-300">Profile</button>
        <button data-tab="subscription" class="tab-btn px-3 py-2 text-sm border-b-2 border-transparent text-slate-300">Subscription</button>
      </div>

      <!-- PROFILE -->
      <section id="tab-profile" class="p-4 border border-slate-800 border-t-0 rounded-b-2xl bg-slate-900/40">
        <div class="grid sm:grid-cols-2 gap-3 text-sm">
          <div><div class="text-slate-400">Discord name</div><div id="prof-name" class="text-slate-100">—</div></div>
          <div><div class="text-slate-400">Email</div><div id="prof-email" class="text-slate-100">—</div></div>
          <div><div class="text-slate-400">User ID</div><div id="prof-id" class="text-slate-100 break-all">—</div></div>
          <div><div class="text-slate-400">Premium</div><div id="prof-premium" class="text-slate-100">—</div></div>
        </div>
      </section>

      <!-- SUBSCRIPTION -->
      <section id="tab-subscription" class="hidden p-4 border border-slate-800 border-t-0 rounded-b-2xl bg-slate-900/40">
        <h2 class="text-xl font-semibold">Premium</h2>
        <p class="text-slate-300 mb-3">Unlock Perspective and unlimited daily analyses.</p>

        <div id="sub-state" class="mb-4 text-slate-300">Checking your status…</div>

        <div class="grid md:grid-cols-2 gap-4">
          <div class="p-4 rounded-xl border border-slate-800">
            <h3 class="font-semibold mb-1">€2/month subscription</h3>
            <p class="text-slate-400 mb-3 text-sm">Recurring monthly via PayPal. Cancel anytime from your PayPal account.</p>
            <div id="paypal-subscribe"></div>
          </div>

          <div class="p-4 rounded-xl border border-slate-800">
            <h3 class="font-semibold mb-1">30-day pass (€2 one-time)</h3>
            <p class="text-slate-400 mb-3 text-sm">One-time purchase: grants 30 days of Premium immediately.</p>
            <div id="paypal-onetime"></div>
          </div>
        </div>

        <div id="sub-msg" class="mt-3 text-sm text-slate-400"></div>
      </section>
    </div>
  </div>

  <!-- Tiny tabs JS -->
  <script>
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.tab-btn'); if(!btn) return;
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('border-indigo-500','text-indigo-300'));
      btn.classList.add('border-indigo-500','text-indigo-300');
      const name = btn.dataset.tab;
      document.querySelectorAll('[id^=tab-]').forEach(s=>s.classList.add('hidden'));
      document.getElementById('tab-' + name).classList.remove('hidden');
    });
    window.addEventListener('load', () => {
      const first = document.querySelector('.tab-btn[data-tab="profile"]');
      if(first) first.click();
    });
  </script>

  <!-- Auth bar + profile load -->
  <script>
    const supa = supabase.createClient(window.SUPA_URL, window.SUPA_ANON);

    async function renderAuthBar(){
      const slot = document.getElementById('authbar');
      const { data:{ user } } = await supa.auth.getUser();
      if(!user){
        slot.innerHTML = `<div class="flex items-center justify-end">
          <button id="signin" class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm">
            Sign in with Discord
          </button>
        </div>`;
        document.getElementById('signin').onclick = ()=> supa.auth.signInWithOAuth({
          provider: 'discord',
          options: { redirectTo: location.href }
        });
        document.getElementById('accStatus').textContent = 'Please sign in to view your account.';
        return null;
      }
      slot.innerHTML = `<div class="flex items-center justify-end gap-2">
        <a href="index.html" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">Leaderboard</a>
        <button id="signout" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">Sign out</button>
      </div>`;
      document.getElementById('signout').onclick = async ()=>{ await supa.auth.signOut(); location.reload(); };
      return user;
    }

    async function loadProfile(){
      const user = await renderAuthBar();
      if(!user) return;

      const meta = user.user_metadata || {};
      const { data: p } = await supa.from('profiles').select('username,premium_until,subscription_id').eq('user_id',user.id).maybeSingle();

      const name  = p?.username || meta.full_name || meta.name || '—';
      const email = user.email || meta.email || '—';
      const until = p?.premium_until ? new Date(p.premium_until) : null;
      const prem  = until && until > new Date() ? `Active (until ${until.toISOString().slice(0,10)})` : 'Not active';

      document.getElementById('prof-name').textContent    = name;
      document.getElementById('prof-email').textContent   = email;
      document.getElementById('prof-id').textContent      = user.id;
      document.getElementById('prof-premium').textContent = prem;

      document.getElementById('accStatus').innerHTML = `Logged in as <b>${name}</b>`;
      document.getElementById('sub-state').textContent = prem;
    }

    document.addEventListener('DOMContentLoaded', loadProfile);
  </script>

  <!-- PayPal SDKs are loaded only if a client id is set -->
  <script>
    function ensurePayPal(params, cb){
      if(!window.PAYPAL_CLIENT_ID){ return; }
      const qs = new URLSearchParams(params).toString();
      const s = document.createElement('script');
      s.src = 'https://www.paypal.com/sdk/js?' + qs;
      s.onload = cb;
      document.head.appendChild(s);
    }

    async function callEdge(url, payload){
      const { data:{ session } } = await supa.auth.getSession();
      const res = await fetch(window.SUPA_URL + '/functions/v1/' + url, {
        method: 'POST',
        headers: { 'Authorization':'Bearer '+(session?.access_token||''), 'Content-Type':'application/json' },
        body: JSON.stringify(payload||{})
      });
      const j = await res.json().catch(()=>({}));
      if(!res.ok) throw new Error(j.error || res.statusText || 'Request failed');
      return j;
    }

    function mountPayPal(){
      // Subscription button
      if(window.PAYPAL_PLAN_ID && window.paypal && paypal.Buttons){
        paypal.Buttons({
          style: { label: 'subscribe' },
          createSubscription: function(data, actions) {
            return actions.subscription.create({ plan_id: window.PAYPAL_PLAN_ID });
          },
          onApprove: async function(data, actions) {
            try{
              await callEdge('activate-paypal-sub', { subscriptionId: data.subscriptionID });
              document.getElementById('sub-msg').textContent = 'Subscription activated. Thank you!';
              loadProfile();
            }catch(e){
              document.getElementById('sub-msg').textContent = 'Activation error: ' + (e.message||e);
            }
          }
        }).render('#paypal-subscribe');
      }

      // One-time 30-day pass
      if(window.paypal && paypal.Buttons){
        paypal.Buttons({
          style: { label: 'pay' },
          createOrder: (data, actions) => actions.order.create({
            intent:'CAPTURE',
            purchase_units:[{ amount:{ currency_code:'EUR', value: window.ONE_TIME_PRICE_EUR || '2.00' } }]
          }),
          onApprove: async (data, actions) => {
            const order = await actions.order.capture();
            try{
              await callEdge('capture-paypal-order', { orderId: order.id });
              document.getElementById('sub-msg').textContent = '30-day pass activated. Enjoy!';
              loadProfile();
            }catch(e){
              document.getElementById('sub-msg').textContent = 'Activation error: ' + (e.message||e);
            }
          }
        }).render('#paypal-onetime');
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      if(!window.PAYPAL_CLIENT_ID) return;
      ensurePayPal({
        'client-id': window.PAYPAL_CLIENT_ID,
        'vault': 'true',
        'intent': 'subscription',
        'currency': 'EUR'
      }, mountPayPal);
    });
  </script>
</body>
</html>
