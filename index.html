<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CG Ranked ‚Äî Live</title>
  <meta name="description" content="Live Crab Game ranked stats: leaderboard, live matches, player pages with rating history." />
  <link rel="icon" href="data:,">
  <style>
    :root{--bg:#0b0e11;--card:#11151a;--muted:#7d8b99;--text:#e8eef5;--accent:#5dd9ff}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0e11,#0f141a 30%,#0b0e11);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial}
    a{color:var(--accent);text-decoration:none}
    header{position:sticky;top:0;backdrop-filter:saturate(1.2) blur(10px);background:rgba(15,20,26,.7);border-bottom:1px solid #1c2430;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .brand{font-weight:700;letter-spacing:.3px}
    .tag{padding:3px 8px;border:1px solid #2a3442;border-radius:999px;color:var(--muted);font-size:12px}
    .search{margin-left:auto;display:flex;gap:8px}
    input,button{border-radius:10px;background:#0e1319;border:1px solid #2a3442;color:var(--text);padding:10px 12px}
    input::placeholder{color:#667788}
    button{cursor:pointer}
    main{padding:24px 0}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:980px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--card);border:1px solid #1c2430;border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 12px;font-size:18px}
    .muted{color:var(--muted)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #1c2430;text-align:left}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #2a3442;border-radius:999px;padding:4px 8px;font-size:12px}
    .right{float:right}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .kbd{border:1px solid #2a3442;padding:2px 6px;border-radius:6px;background:#0b0f14}
    .hidden{display:none}
    .hero{display:flex;align-items:center;justify-content:space-between;gap:16px}
    .hero h1{margin:8px 0 0}
    .flex{display:flex;gap:10px;align-items:center}
    .stack{display:flex;flex-direction:column;gap:8px}
    .small{font-size:12px}
    canvas{max-width:100%}
  </style>
</head>
<body>
  <header>
    <div class="wrap row">
      <div class="flex">
        <div class="brand">CG Ranked</div>
        <span class="tag">live</span>
      </div>
      <nav class="row" style="gap:10px">
        <a href="#/leaderboard">Leaderboard</a>
        <a href="#/matches">Matches</a>
        <a href="#/about">About</a>
      </nav>
      <div class="search">
        <input id="searchSteam" class="mono" placeholder="SteamID64 or Steam vanity / URL" />
        <button id="goPlayer">Open Player</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="page-leaderboard" class="grid hidden">
      <div class="card">
        <h2>üèÜ Leaderboard</h2>
        <div class="small muted">Sorted by RP then Elo. Updates in real time.</div>
        <table class="table" id="tbl-leaderboard">
          <thead>
          <tr><th>#</th><th>Player</th><th>Rank</th><th>RP</th><th>Elo</th><th>Games</th><th>Win%</th><th class="right">Last active</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card">
        <h2>üéÆ Lobby (optional)</h2>
        <div id="lobbyBox" class="stack small"></div>
      </div>
    </section>

    <section id="page-matches" class="grid hidden">
      <div class="card">
        <h2>‚ú® Live Matches</h2>
        <div id="liveMatches" class="stack"></div>
      </div>
      <div class="card">
        <h2>Recent Matches</h2>
        <div class="small muted">Latest 25</div>
        <div id="recentMatches" class="stack"></div>
      </div>
    </section>

    <section id="page-player" class="stack hidden">
      <div class="card hero">
        <div>
          <div class="small muted">Player profile</div>
          <h1 id="p-username">‚Äî</h1>
          <div class="flex small">
            <span>Steam: <span id="p-steam" class="mono"></span></span>
            <a target="_blank" id="p-steamlink">Open Steam Profile ‚Üó</a>
          </div>
        </div>
        <div class="stack small">
          <div>Rank: <b id="p-rank">‚Äî</b></div>
          <div>RP: <b id="p-rp">‚Äî</b> &nbsp; Elo: <b id="p-elo">‚Äî</b></div>
          <div>Last active: <span id="p-last">‚Äî</span></div>
        </div>
      </div>
      <div class="card">
        <h2>Rating History</h2>
        <canvas id="eloChart" height="140"></canvas>
      </div>
      <div class="card">
        <h2>Match History</h2>
        <div id="p-matches" class="stack"></div>
      </div>
    </section>

    <section id="page-about" class="stack hidden">
      <div class="card">
        <h2>About</h2>
        <p class="small muted">
          This site runs on GitHub Pages and connects to a Supabase database for live updates:
          leaderboard, live match feed, and player pages with rating graphs.
        </p>
        <ul class="small">
          <li>Hash routing (e.g., <span class="mono">#/player/&lt;steamId&gt;</span>)</li>
          <li>WebSocket updates for <span class="mono">matches</span></li>
          <li>Charts for Elo/RP history</li>
        </ul>
        <p class="small">Tip: open a player quickly ‚Äî paste a Steam profile URL or vanity, then press <span class="kbd">Enter</span>.</p>
      </div>
    </section>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
  <script type="module">
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const SUPABASE_URL  = "https://qjxmzdphulrwkscyceip.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFqeG16ZHBodWxyd2tzY3ljZWlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjA3NzYsImV4cCI6MjA3NzU5Njc3Nn0._3SbLJi0X29k4xoL48KhXyCqFjjRLE_yeeWiAxGqdmE";

    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const $ = (sel, el=document) => el.querySelector(sel);
    const el = (tag, cls) => { const n = document.createElement(tag); if(cls) n.className = cls; return n; };
    const fmt = t => new Date(t).toLocaleString();
    const pct = (a,b) => b ? Math.round((a/b)*100) : 0;
    const esc = s => String(s ?? "").replace(/[&<>\"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Router ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const pages = {
      leaderboard: $('#page-leaderboard'),
      matches: $('#page-matches'),
      player: $('#page-player'),
      about: $('#page-about')
    };
    const routes = {
      '#/leaderboard': showLeaderboard,
      '#/matches': showMatches,
      '#/player': showPlayer,
      '#/about': showAbout,
      '': () => location.hash = '#/leaderboard'
    };
    function onHash(){
      const hash = location.hash.split('/').slice(0,2).join('/');
      Object.values(pages).forEach(p => p.classList.add('hidden'));
      (routes[hash] || routes[''])();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Leaderboard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function showLeaderboard(){
      pages.leaderboard.classList.remove('hidden');

      const { data: players } = await sb
        .from('players')
        .select('steam_id,username,elo,rp,last_active_at,rank,games_played,wins')
        .order('rp', { ascending:false })
        .order('elo', { ascending:false })
        .limit(200);

      const tb = $('#tbl-leaderboard tbody');
      tb.innerHTML = '';
      (players || []).forEach((p, i) => {
        const tr = el('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td><a href="#/player/${esc(p.steam_id)}">${esc(p.username || 'player')}</a></td>
          <td>${esc(p.rank || '-')}</td>
          <td class="mono">${p.rp ?? '-'}</td>
          <td class="mono">${p.elo ?? '-'}</td>
          <td>${p.games_played ?? '-'}</td>
          <td>${pct(p.wins||0, p.games_played||0)}%</td>
          <td class="right small muted">${p.last_active_at ? fmt(p.last_active_at) : '‚Äî'}</td>`;
        tb.appendChild(tr);
      });

      // Optional: if you store lobby info in a single-row table
      try {
        const { data: lobby } = await sb.from('lobby_info').select('*').limit(1).maybeSingle();
        const box = $('#lobbyBox'); box.innerHTML = '';
        if (lobby) {
          const row = (k,v)=>{ const d = el('div'); d.innerHTML = `<span class="muted">${k}:</span> <b>${esc(v??'-')}</b>`; return d;};
          box.append(row('Code', lobby.code));
          box.append(row('Players', `${lobby.players}/${lobby.max}`));
          box.append(row('Updated', fmt(lobby.updated_at)));
        } else {
          box.innerHTML = '<span class="muted">No data</span>';
        }
      } catch {}
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Matches ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let liveChan;
    async function showMatches(){
      pages.matches.classList.remove('hidden');
      const live = $('#liveMatches'); live.innerHTML = '';
      const recent = $('#recentMatches'); recent.innerHTML = '';

      const { data } = await sb.from('matches')
        .select('played_at,map_id,p1_id,p2_id,winner_id,replay_url,duration_seconds')
        .order('played_at',{ascending:false}).limit(25);
      (data || []).forEach(m => recent.append(matchCard(m)));

      if (!liveChan) {
        liveChan = sb.channel('matches-feed')
          .on('postgres_changes', { event:'INSERT', schema:'public', table:'matches' }, payload => {
            live.prepend(matchCard(payload.new, true));
          })
          .subscribe();
      }
    }

    function matchCard(m, pulse=false){
      const card = el('div','card');
      if (pulse) card.style.outline = '1px solid var(--accent)';
      const when = fmt(m.played_at);
      const win = m.winner_id ? ` ‚Äî <b>Winner:</b> <span class="mono">${esc(m.winner_id)}</span>` : '';
      card.innerHTML = `Map <b>${m.map_id}</b> ‚Ä¢ <span class="mono">${esc(m.p1_id)}</span> vs <span class="mono">${esc(m.p2_id)}</span>${win}
        <span class="right small muted">${when}</span>
        <div class="small">${m.replay_url ? `<a target="_blank" href="${esc(m.replay_url)}">Replay</a>` : ''}</div>`;
      return card;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let eloChart;
    async function showPlayer(){
      pages.player.classList.remove('hidden');
      const steam = location.hash.split('/')[2] || '';
      if (!steam) { location.hash = '#/leaderboard'; return; }

      $('#p-steam').textContent = steam;
      $('#p-steamlink').href = `https://steamcommunity.com/profiles/${steam}`;

      const { data: p } = await sb.from('players').select('*').eq('steam_id', steam).maybeSingle();
      $('#p-username').textContent = p?.username || '‚Äî';
      $('#p-rank').textContent = p?.rank || '‚Äî';
      $('#p-rp').textContent = p?.rp ?? '‚Äî';
      $('#p-elo').textContent = p?.elo ?? '‚Äî';
      $('#p-last').textContent = p?.last_active_at ? fmt(p.last_active_at) : '‚Äî';

      const { data: hist } = await sb.from('matches')
        .select('id,played_at,map_id,p1_id,p2_id,winner_id,replay_url')
        .or(`p1_id.eq.${steam},p2_id.eq.${steam}`)
        .order('played_at',{ascending:false}).limit(100);

      const box = $('#p-matches'); box.innerHTML = '';
      (hist || []).forEach(m => {
        const meWin = m.winner_id === steam ? '‚úÖ' : (m.winner_id ? '‚ùå' : '‚Ä¢');
        const opp = m.p1_id === steam ? m.p2_id : m.p1_id;
        const row = el('div','stack');
        row.innerHTML = `${meWin} Map <b>${m.map_id}</b> vs <span class="mono">${esc(opp)}</span> ¬∑ <span class="small muted">${fmt(m.played_at)}</span>
          ${m.replay_url ? `<div class="small"><a target="_blank" href="${esc(m.replay_url)}">Replay</a></div>` : ''}`;
        box.append(row);
      });

      const { data: series } = await sb.from('ratings')
        .select('at,elo_after,rp_after')
        .eq('player_id', steam)
        .order('at');

      const labels = (series || []).map(r => new Date(r.at));
      const eloData = (series || []).map(r => r.elo_after ?? null);
      const rpData  = (series || []).map(r => r.rp_after ?? null);

      const ctx = $('#eloChart').getContext('2d');
      if (eloChart) eloChart.destroy();
      eloChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          { label:'Elo', data:eloData, tension:.2 },
          { label:'RP',  data:rpData,  tension:.2 }
        ]},
        options:{
          responsive:true,
          plugins:{ legend:{ labels:{ color:'#c9d4de' } } },
          scales:{ x:{ ticks:{ color:'#8fa1b3' } }, y:{ ticks:{ color:'#8fa1b3' } } }
        }
      });

      // live subscribe for this player
      sb.channel(`player-${steam}`)
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'matches',filter:`p1_id=eq.${steam}`},p=>{ $('#p-matches').prepend(matchCard(p.new,true)); })
        .on('postgres_changes',{event:'INSERT',schema:'public',table:'matches',filter:`p2_id=eq.${steam}`},p=>{ $('#p-matches').prepend(matchCard(p.new,true)); })
        .subscribe();
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ About ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function showAbout(){ pages.about.classList.remove('hidden'); }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Search ‚Üí Player ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    $('#goPlayer').onclick = gotoPlayer;
    $('#searchSteam').addEventListener('keydown', e => { if (e.key === 'Enter') gotoPlayer(); });

    async function gotoPlayer(){
      const raw = $('#searchSteam').value.trim();
      if (!raw) return;
      const id = await resolveSteamId(raw) || raw;
      location.hash = `#/player/${id}`;
    }

    // Steam vanity/URL ‚Üí steam64 (public XML)
    async function resolveSteamId(arg){
      if (/^\d{17}$/.test(arg)) return arg;
      try{
        if (arg.startsWith('http')) {
          const u = new URL(arg);
          const parts = u.pathname.split('/').filter(Boolean);
          if (parts[0] === 'profiles' && /^\d{17}$/.test(parts[1])) return parts[1];
          if (parts[0] === 'id' && parts[1]) return fetchVanity(parts[1]);
        }
        if (!arg.includes(' ')) return fetchVanity(arg);
      }catch{}
      return null;
    }
    async function fetchVanity(v){
      try{
        const r = await fetch(`https://steamcommunity.com/id/${encodeURIComponent(v)}?xml=1`);
        const xml = await r.text();
        const m = xml.match(/<steamID64>\s*(\d{17})\s*<\/steamID64>/);
        return m ? m[1] : null;
      }catch{ return null }
    }

    // Init
    window.addEventListener('hashchange', onHash);
    onHash();
  </script>
</body>
</html>
