<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CG Ranked — Leaderboard</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1620;
      --panel:#111a27;
      --panel-2:#0d1520;
      --text:#e6eef8;
      --muted:#9db0c6;
      --accent:#6ee7ff;
      --accent-2:#42d392;
      --line:#1d2a3a;
      --danger:#ff5d5d;
      --yellow:#ffd166;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;height:100%}
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, #132235 0%, #0f1620 60%);
      color: var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1200px;margin:0 auto;padding:24px}
    .nav{
      position:sticky;top:0;z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
      background: rgba(9,14,22,.6);border-bottom:1px solid var(--line);
    }
    .nav-wrap{display:flex;gap:16px;align-items:center;max-width:1200px;margin:0 auto;padding:12px 24px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand-badge{width:28px;height:28px;display:grid;place-items:center;border-radius:6px;background:linear-gradient(135deg,#42d392 0%,#2dd4bf 50%,#06b6d4 100%);color:#08111b;font-weight:900}
    .tabs{display:flex;gap:8px;margin-left:16px}
    .tab{padding:8px 12px;border-radius:8px;color:var(--muted)}
    .tab.active{color:var(--text);background:linear-gradient(180deg,#131e2b 0%, #101826 100%);border:1px solid var(--line)}
    .right{margin-left:auto;display:flex;gap:8px;align-items:center}
    .input{background:#0c1420;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;outline:none;width:260px}
    .btn{background:linear-gradient(180deg,#1a2a3b,#152233);border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    .grid{display:grid;grid-template-columns: 1.3fr .9fr; gap:20px;align-items:start}
    .card{background:linear-gradient(180deg,#111a27,#0d1520);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:16px 18px;border-bottom:1px solid var(--line);font-size:18px;display:flex;align-items:center;gap:10px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:12px 14px;border-bottom:1px solid var(--line);font-size:14px}
    th{color:var(--muted);text-align:left;font-weight:600;background:#0f1826}
    tr:hover td{background:#0f1a28}
    .muted{color:var(--muted)}
    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#0f1826;color:var(--muted)}
    .kpi{display:flex;gap:10px;align-items:center}
    .ok{color:var(--accent-2)}
    .warn{color:var(--yellow)}
    .err{color:var(--danger)}
    .sub{font-size:12px;color:var(--muted);margin-left:10px}
    .footer{opacity:.6;text-align:center;margin:24px 0 40px}
    .status{padding:10px 14px;color:var(--muted)}
    .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:8px;background:#0e1723;border:1px solid var(--line);font-size:12px}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.44.4/dist/umd/supabase.min.js"></script>
</head>
<body>
  <header class="nav">
    <div class="nav-wrap">
      <a class="brand" href="./index.html#leaderboard">
        <span class="brand-badge">CG</span> Ranked
      </a>
      <nav class="tabs">
        <a class="tab active" href="./index.html#leaderboard">Leaderboard</a>
        <a class="tab" href="./index.html#players">Players</a>
      </nav>
      <div class="right">
        <span class="badge">Live <span class="ok">●</span></span>
      </div>
    </div>
  </header>

  <main class="container">
    <div class="grid">
      <section class="card">
        <h2>Live Leaderboard <span id="meta" class="sub"></span></h2>
        <div class="status" id="statusBoard"></div>
        <div style="padding: 10px 14px; display:flex; gap:8px; align-items:center;">
          <input id="search" class="input" placeholder="Search player by name or SteamID..." />
          <button class="btn" id="btnSearch">Search</button>
        </div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Player</th>
                <th>Rank</th>
                <th>RP</th>
                <th>Elo</th>
                <th>Games</th>
                <th>Win%</th>
                <th>Last active</th>
              </tr>
            </thead>
            <tbody id="tbodyBoard"></tbody>
          </table>
        </div>
      </section>

      <aside class="card">
        <h2>Recent Matches</h2>
        <div class="status muted" id="statusMatches">Loading…</div>
        <div style="overflow:auto;">
          <table>
            <thead>
              <tr>
                <th>When</th>
                <th>P1</th>
                <th>P2</th>
                <th>Score</th>
                <th>Map</th>
              </tr>
            </thead>
            <tbody id="tbodyMatches"></tbody>
          </table>
        </div>
      </aside>
    </div>
    <p class="footer muted">UI inspired by chess.com • Built for Crab Game ranked.</p>
  </main>

<script>
// === CONFIG — REMPLACE UNIQUEMENT CES 2 LIGNES ================================
const SUPABASE_URL  = "https://qnxjrkedbplfrlkjqifh.supabase.co"; // <= ton projet
const SUPABASE_ANON = "REPLACE_WITH_PUBLIC_ANON_KEY";             // <= ta clé anon
// ==============================================================================

if (SUPABASE_ANON.includes("REPLACE")) {
  document.getElementById('statusBoard').innerHTML =
    '<span class="warn">Configure SUPABASE_ANON inside index.html (top of script).</span>';
}

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

const fmtTime = (iso) => {
  if (!iso) return '-';
  try{
    const d = new Date(iso);
    return d.toLocaleString();
  }catch{ return iso; }
};
const pct = (w,g) => g>0 ? Math.round((w/g)*100) + '%' : '0%';
const openPlayer = (sid) => window.location.href = `./player.html?sid=${encodeURIComponent(sid)}`;

async function loadBoard(queryText=""){
  const st = document.getElementById('statusBoard');
  st.textContent = "Loading…";

  let sel = sb.from('players')
    .select('steam_id, username, rank, elo, rp, games_played, wins, last_active_at')
    .order('rp',{ascending:false}).order('elo',{ascending:false}).limit(200);

  if (queryText){
    // recherche simple : si nombre, on teste l'id, sinon username ilike
    if (/^\d+$/.test(queryText)) sel = sel.eq('steam_id', queryText);
    else sel = sel.ilike('username', `%${queryText}%`);
  }

  const { data, error } = await sel;
  if (error){
    st.innerHTML = '<span class="err">Failed to load data: '+error.message+'</span>';
    return;
  }
  st.textContent = "";
  const tbody = document.getElementById('tbodyBoard');
  tbody.innerHTML = "";
  const meta = document.getElementById('meta');
  meta.textContent = `Players: ${data.length}`;
  data.forEach((p,idx)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${idx+1}</td>
      <td><a href="javascript:void(0)" class="ok" onclick="openPlayer('${p.steam_id}')">${p.username ?? p.steam_id}</a><div class="muted" style="font-size:12px">${p.steam_id}</div></td>
      <td>${p.rank ?? '-'}</td>
      <td>${p.rp ?? 0}</td>
      <td>${p.elo ?? 0}</td>
      <td>${p.games_played ?? 0}</td>
      <td>${pct(p.wins ?? 0, p.games_played ?? 0)}</td>
      <td>${fmtTime(p.last_active_at)}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function loadMatches(){
  const box = document.getElementById('tbodyMatches');
  const st  = document.getElementById('statusMatches');
  const { data, error } = await sb.from('matches')
    .select('played_at, p1_id, p2_id, p1_score, p2_score, map_id')
    .order('played_at', {ascending:false}).limit(20);
  if (error){
    st.innerHTML = '<span class="err">'+error.message+'</span>';
    return;
  }
  st.textContent = "";
  box.innerHTML = "";
  data.forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${fmtTime(m.played_at)}</td>
      <td><a class="ok" href="./player.html?sid=${encodeURIComponent(m.p1_id)}">${(m.p1_id||'').slice(-6)}</a></td>
      <td><a class="ok" href="./player.html?sid=${encodeURIComponent(m.p2_id)}">${(m.p2_id||'').slice(-6)}</a></td>
      <td>${m.p1_score ?? 0}–${m.p2_score ?? 0}</td>
      <td>${m.map_id ?? '-'}</td>
    `;
    box.appendChild(tr);
  });
}

document.getElementById('btnSearch').addEventListener('click', ()=>{
  const q = document.getElementById('search').value.trim();
  loadBoard(q);
});
document.getElementById('search').addEventListener('keydown', (e)=>{
  if (e.key === 'Enter') document.getElementById('btnSearch').click();
});

// initial
loadBoard();
loadMatches();

// live refresh (30s)
setInterval(()=>{
  loadBoard(document.getElementById('search').value.trim());
  loadMatches();
}, 30000);
</script>
</body>
</html>
