<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CG Ranked â€” Live Leaderboard</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1420;--panel:#101b2a;--muted:#8aa0b8;--text:#e6f0ff;--accent:#2ea3ff;}
*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial}
nav{display:flex;gap:24px;align-items:center;padding:16px 24px;border-bottom:1px solid #1c2a3f;background:#0d1623;position:sticky;top:0}
nav .brand{font-weight:700}
.container{max-width:1200px;margin:24px auto;padding:0 16px}
.panel{background:var(--panel);border:1px solid #1b2940;border-radius:12px;padding:16px}
.grid{display:grid;grid-template-columns:1fr 420px;gap:16px}
h1{margin:0 0 12px 0;font-size:20px} .muted{color:var(--muted)}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid #1b2940;text-align:left}
th{color:#9fb6cf;font-weight:600}
a{color:var(--text);text-decoration:none}
a:hover{color:var(--accent)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#14263d;color:#c7ddff;font-size:12px}
.search{display:flex;gap:8px}
input[type="text"]{background:#0c1420;border:1px solid #1b2940;border-radius:8px;color:var(--text);padding:10px 12px;flex:1}
button{background:var(--accent);border:0;color:#001222;border-radius:8px;padding:10px 14px;font-weight:600;cursor:pointer}
</style>
</head>
<body>
<nav>
  <div class="brand">CG Ranked</div>
  <a href="#/leaderboard">Leaderboard</a>
  <a href="#/players">Players</a>
</nav>
<div class="container">
  <div class="grid">
    <section class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h1>Live Leaderboard</h1>
        <div class="search">
          <input id="q" placeholder="Search player by name or SteamID64...">
          <button onclick="searchPlayer()">Search</button>
        </div>
      </div>
      <div class="muted" id="meta"></div>
      <table id="lb">
        <thead><tr>
          <th>#</th><th>Player</th><th>Rank</th><th>Elo</th><th>RP</th><th>Games</th><th>Win%</th><th>Last active</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </section>
    <aside class="panel">
      <h1 style="margin-bottom:8px">Recent Matches</h1>
      <table id="last">
        <thead><tr><th>When</th><th>P1</th><th>P2</th><th>Score</th><th>Map</th></tr></thead>
        <tbody></tbody>
      </table>
    </aside>
  </div>
</div>

<script>
// ====== CONFIG (fill with your public anon key & URL) ======
const SUPABASE_URL  = "https://REPLACE_WITH_YOURS.supabase.co";
const SUPABASE_ANON = "REPLACE_WITH_PUBLIC_ANON_KEY";
// ===========================================================

const headers = {"apikey": SUPABASE_ANON, "Authorization": "Bearer " + SUPABASE_ANON};

async function fetchJSON(url) {
  const r = await fetch(url, {headers});
  if (!r.ok) throw new Error(await r.text());
  return await r.json();
}

function esc(s){return (s??"").toString()}
function td(text){const el=document.createElement("td"); el.textContent=text; return el}
function linkPlayer(id, name){
  const a=document.createElement("a");
  a.href=`/player.html?sid=${encodeURIComponent(id)}`;
  a.textContent=name||id;
  return a;
}

async function load() {
  const meta = document.getElementById("meta");
  const tbody = document.querySelector("#lb tbody");
  const last  = document.querySelector("#last tbody");
  tbody.innerHTML = ""; last.innerHTML = "";
  try{
    const players = await fetchJSON(`${SUPABASE_URL}/rest/v1/players?select=*&order=rp.desc,elo.desc&limit=200`);
    const matches = await fetchJSON(`${SUPABASE_URL}/rest/v1/matches?select=*&order=played_at.desc&limit=20`);

    meta.textContent = `Players: ${players.length} | Matches: ${matches.length} | Updated: ${new Date().toLocaleTimeString()}`;

    players.forEach((p,i)=>{
      const tr=document.createElement("tr");
      tr.appendChild(td(i+1));
      const name=document.createElement("td"); name.appendChild(linkPlayer(p.steam_id, p.username)); tr.appendChild(name);
      tr.appendChild(td(esc(p.rank)||"-"));
      tr.appendChild(td(esc(p.elo)));
      tr.appendChild(td(esc(p.rp)||"0"));
      tr.appendChild(td(esc(p.games_played)||"0"));
      const wins = Number(p.wins||0), games = Number(p.games_played||0);
      const winpct = games ? Math.round(100*wins/games) : 0;
      tr.appendChild(td(winpct+"%"));
      tr.appendChild(td((p.last_active_at||"").replace("T"," ").split(".")[0]));
      tbody.appendChild(tr);
    });

    matches.forEach(m=>{
      const tr=document.createElement("tr");
      tr.appendChild(td((m.played_at||"").replace("T"," ").split(".")[0]));
      tr.appendChild(td(m.p1_id?.slice(-6)||""));
      tr.appendChild(td(m.p2_id?.slice(-6)||""));
      tr.appendChild(td(`${m.p1_score||0}-${m.p2_score||0}`));
      tr.appendChild(td(m.map_id||"-"));
      last.appendChild(tr);
    });

  }catch(e){
    meta.textContent = "Failed to load data: " + e.message;
  }
}

function searchPlayer(){
  const v=document.getElementById("q").value.trim();
  if(!v) return;
  // naive: if numeric assume steamid, else username query page uses server-side filter
  location.href = "/player.html?sid=" + encodeURIComponent(v);
}

load();
setInterval(load, 15000);
</script>
</body>
</html>
