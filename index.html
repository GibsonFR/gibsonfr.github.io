<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ranked Tag ‚Äî Leaderboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-slate-950 text-slate-100">

  <!-- Auth bar -->
  <div class="max-w-6xl mx-auto p-4">
    <div id="authbar" class="mb-3"></div>
  </div>

  <div class="max-w-6xl mx-auto p-4">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
      <h1 class="text-2xl font-bold">üèÜ Ranked Tag ‚Äî Live Leaderboard</h1>
      <div class="flex items-center gap-2">
        <input id="search" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="Search username or SteamID">
        <button id="go" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Search</button>
      </div>
    </header>

    <section class="mb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div class="flex items-center gap-3">
        <span id="status" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm">Loading‚Ä¶</span>
        <label class="text-sm text-slate-400">Page size</label>
        <select id="pageSize" class="bg-slate-900 border border-slate-800 rounded px-2 py-1">
          <option>100</option>
          <option>250</option>
          <option>500</option>
          <option selected>1000</option>
        </select>
        <button id="refresh" class="hidden px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-sm">Refresh data</button>
      </div>
      <div id="pager" class="flex items-center gap-2 text-sm"></div>
    </section>

    <section>
      <div id="board" class="overflow-x-auto border border-slate-800 rounded"></div>
    </section>

    <section class="mt-10">
      <h2 class="text-xl font-semibold mb-2">Recent Matches</h2>
      <div id="recent" class="grid md:grid-cols-2 gap-3"></div>
    </section>
  </div>

  <script>
    const SUPA_URL  = "https://yykwhpeczfapkileuxtb.supabase.co";
    const SUPA_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5a3docGVjemZhcGtpbGV1eHRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMjM4NzUsImV4cCI6MjA3NzU5OTg3NX0.Sz2G1DG0CVYC9WSuYSODnH9k0_ybVluZAtRGBwb55wo";
    const supa = supabase.createClient(SUPA_URL, SUPA_ANON);

    // ---------- PREMIUM MARKING ----------
    // Set of premium steam IDs. Filled from DB (profiles) and at least for the signed-in user.
    const premiumSteam = new Set();

    // Crown icon (inline SVG). Tooltip set on the wrapper <span>.
    const crownSVG = `<span title="Premium member" aria-label="Premium member">
      <svg class="inline-block ml-1 h-4 w-4 align-[-1px] text-amber-300" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
        <path d="M5 19h14a1 1 0 0 0 1-1v-7.5l-3.8 2.85a1 1 0 0 1-1.52-.47L12 5.6l-2.68 7.28a1 1 0 0 1-1.52.47L4 10.5V18a1 1 0 0 0 1 1Zm-3 2a1 1 0 1 0 0 2h20a1 1 0 1 0 0-2H2Z"/>
      </svg>
    </span>`;

    function premiumNameHtml(row) {
      const baseName = esc(row.username || row.steam_id);
      const isPremium = premiumSteam.has(String(row.steam_id));
      const title = isPremium ? ' title="Premium member"' : '';
      if (isPremium) {
        return `<a${title} class="text-amber-300 hover:text-amber-200" href="player.html?steam_id=${encodeURIComponent(row.steam_id)}">${baseName}</a>${crownSVG}`;
      }
      return `<a class="text-indigo-400 hover:underline" href="player.html?steam_id=${encodeURIComponent(row.steam_id)}">${baseName}</a>`;
    }

    // Fetch all premium steam IDs directly from Supabase (requires RLS policy to allow select)
    async function fetchPremiumDirect() {
      try {
        const nowIso = new Date().toISOString();
        const step = 1000;
        let from = 0;
        for (;;) {
          const { data, error } = await supa
            .from('profiles')
            .select('steam_id,premium_until')
            .not('steam_id', 'is', null)
            .gt('premium_until', nowIso)
            .range(from, from + step - 1);

          if (error) {
            console.warn('[premium] select error', error);
            break;
          }
          if (!data || data.length === 0) break;
          for (const r of data) {
            if (r.steam_id) premiumSteam.add(String(r.steam_id));
          }
          if (data.length < step) break;
          from += step;
        }
      } catch (e) {
        console.warn('[premium] fetch failed', e);
      }
    }

    // Self-mark (ensures at least the signed-in user is marked premium if applicable)
    function getDiscordId(user){
      const ids = user?.identities || [];
      const disc = ids.find(i => i?.provider === 'discord');
      const fromIdent = disc?.identity_data?.user_id || disc?.identity_data?.sub || disc?.identity_data?.id;
      const fromMeta  = user?.user_metadata?.provider_id || user?.user_metadata?.sub || null;
      return String(fromIdent || fromMeta || '').trim() || null;
    }
    async function markSelfIfPremium() {
      try {
        const { data:{ user } } = await supa.auth.getUser();
        if (!user) return;
        const { data: prof } = await supa.from('profiles')
          .select('premium_until')
          .eq('id', user.id)
          .maybeSingle();
        const active = !!(prof?.premium_until && new Date(prof.premium_until) > new Date());
        if (!active) return;

        const res = await fetch('links_state.json', { cache:'no-store' });
        if (!res.ok) return;
        const map = await res.json();
        const did = getDiscordId(user);
        const sid = did ? map[did] : null;
        if (sid) premiumSteam.add(String(sid));
      } catch {}
    }

    async function initPremium() {
      await Promise.all([ markSelfIfPremium(), fetchPremiumDirect() ]);
    }

    // ---------- state ----------
    let pageSize = 1000, pageIndex = 0;
    let total = 0;
    let allRows = [];
    let sortedRows = [];
    let currentSort = { key: 'rank', dir: 'desc' };

    // ---------- utils ----------
    function esc(s){return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function tierOrder(rank){
      const r=(rank||'').toLowerCase();
      if(r.startsWith('chall')) return 9;
      if(r.startsWith('gm')||r.startsWith('grand')) return 8;
      if(r.startsWith('master')) return 7;
      if(r.startsWith('diamond')) return 6;
      if(r.startsWith('platinum')) return 5;
      if(r.startsWith('gold')) return 4;
      if(r.startsWith('silver')) return 3;
      if(r.startsWith('bronze')) return 2;
      if(r.startsWith('clown')) return 1;
      return 0;
    }
    function divFromRank(rank){
      const last=(rank||'').trim().split(/\s+/).pop().toUpperCase();
      const map={I:1,II:2,III:3,IV:4}; return map[last]||4;
    }
    function header(label,key){
      const arrow = currentSort.key===key ? (currentSort.dir==='asc'?' ‚ñ≤':' ‚ñº') : '';
      return `<th class="p-2 text-left select-none cursor-pointer" data-sort="${key}">${label}${arrow}</th>`;
    }
    function applySort(rows){
      const dir = currentSort.dir, k=currentSort.key;
      const cmp=(a,b)=>{
        const s=v=> (v==null? -Infinity : v);
        if(k==='rank'){
          const t=tierOrder(b.rank)-tierOrder(a.rank); if(t) return t;
          const d=divFromRank(a.rank)-divFromRank(b.rank); if(d) return d;
          const r=(b.rp??0)-(a.rp??0); if(r) return r;
          return (b.elo??0)-(a.elo??0);
        }
        if(k==='player') return (a.username||'').localeCompare(b.username||'',undefined,{sensitivity:'base'});
        if(k==='rp')     return s(b.rp)-s(a.rp);
        if(k==='elo')    return s(b.elo)-s(a.elo);
        if(k==='games')  return s(b.games)-s(a.games);
        if(k==='wr')     return s(b.win_rate)-s(a.win_rate);
        return 0;
      };
      rows.sort(cmp);
      if(dir==='asc') rows.reverse();
      rows.forEach((r,i)=> r.__pos = i+1);
      return rows;
    }

    // ---------- render ----------
    function renderTable(slice){
      const thead = `<thead class="bg-slate-900">
        <tr>
          ${header('#','rank')}
          ${header('Player','player')}
          ${header('Rank','rank')}
          ${header('RP','rp')}
          ${header('Elo','elo')}
          ${header('Games','games')}
          ${header('Win%','wr')}
        </tr>
      </thead>`;

      const body = slice.map(r=>`
        <tr class="border-t border-slate-800 hover:bg-slate-900">
          <td class="p-2">${r.__pos}</td>
          <td class="p-2">${premiumNameHtml(r)}</td>
          <td class="p-2 text-center">${esc(r.rank||'')}</td>
          <td class="p-2 text-center">${r.rp??''}</td>
          <td class="p-2 text-center">${r.elo??''}</td>
          <td class="p-2 text-center">${r.games??0}</td>
          <td class="p-2 text-center">${r.win_rate??0}</td>
        </tr>`).join('');

      document.getElementById('board').innerHTML =
        `<table class="w-full text-sm">${thead}<tbody>${body}</tbody></table>`;

      document.querySelectorAll('[data-sort]').forEach(th=>{
        th.onclick = ()=>{
          const key=th.getAttribute('data-sort');
          if(currentSort.key===key) currentSort.dir = currentSort.dir==='asc'?'desc':'asc';
          else { currentSort.key=key; currentSort.dir=(key==='player'?'asc':'desc'); }
          sortedRows = applySort([...allRows]);
          pageIndex = 0; render();
        };
      });
    }
    function renderPager(){
      const pages = Math.max(1, Math.ceil(total / pageSize));
      const el = document.getElementById('pager');
      el.innerHTML = `
        <button id="first" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex<=0?'opacity-50':''}">¬´ First</button>
        <button id="prev"  class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex<=0?'opacity-50':''}">‚Äπ Prev</button>
        <span class="text-slate-300">Page <b>${pageIndex+1}</b> / ${pages} ¬∑ Total <b>${total}</b></span>
        <button id="next"  class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex>=pages-1?'opacity-50':''}">Next ‚Ä∫</button>
        <button id="last"  class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex>=pages-1?'opacity-50':''}">Last ¬ª</button>`;
      document.getElementById('first').onclick=()=>{pageIndex=0; render();};
      document.getElementById('prev').onclick =()=>{if(pageIndex>0){pageIndex--; render();}};
      document.getElementById('next').onclick =()=>{const p=Math.ceil(total/pageSize); if(pageIndex<p-1){pageIndex++; render();}};
      document.getElementById('last').onclick =()=>{pageIndex=Math.ceil(total/pageSize)-1; render();};
    }
    function render(){
      const start = pageIndex*pageSize, end=start+pageSize;
      renderTable(sortedRows.slice(start,end));
      renderPager();
    }

    // ---------- data ----------
    async function loadAll(reload=false){
      document.getElementById('status').textContent = reload ? 'Refreshing‚Ä¶' : 'Loading‚Ä¶';
      const { count, error } = await supa.from('view_leaderboard')
        .select('steam_id', { count: 'exact', head: false })
        .range(0,0);
      if(error){ console.error(error); document.getElementById('status').textContent='Error'; return; }
      total = count||0;

      const step=1000, pages=Math.ceil(total/step);
      const rows=[];
      for(let i=0;i<pages;i++){
        const a=i*step, b=a+step-1;
        const { data, error:e2 } = await supa.from('view_leaderboard')
          .select('steam_id,username,rank,elo,rp,games,wins,win_rate')
          .range(a,b);
        if(e2){ console.error(e2); continue; }
        rows.push(...(data||[]));
        document.getElementById('status').textContent = `Loaded ${Math.min(b+1,total)}/${total}`;
      }
      allRows = rows;
      sortedRows = applySort([...allRows]);
      pageIndex = 0;
      document.getElementById('status').textContent = `Ready ¬∑ ${total} players`;
      render();
    }

    // ---------- recent matches ----------
    async function loadRecent(){
      const { data, error } = await supa.from('matches')
        .select('id, played_at, p1_name, p2_name, winner, map_id, replay_url')
        .order('played_at',{ascending:false}).limit(20);
      if(error){ console.error(error); return; }
      const cont=document.getElementById('recent'); cont.innerHTML='';
      for(const m of (data||[])){
        const w = m.winner==='1' ? (m.p1_name||'P1') : (m.winner==='2' ? (m.p2_name||'P2') : '‚Äî');
        cont.innerHTML += `<a href="match.html?id=${m.id}" class="block p-3 rounded border border-slate-800 hover:border-indigo-500">
          <div class="text-slate-300 text-sm">${new Date(m.played_at).toLocaleString()}</div>
          <div class="font-semibold">${esc(m.p1_name||'P1')} vs ${esc(m.p2_name||'P2')}</div>
          <div class="text-slate-400 text-sm">Winner: <span class="text-slate-100">${esc(w)}</span> ¬∑ Map ${m.map_id??'-'}</div>
        </a>`;
      }
    }

    // ---------- bindings ----------
    document.getElementById('go').onclick = ()=>{
      const q=document.getElementById('search').value.trim();
      if(!q) return; window.location.href=`player.html?q=${encodeURIComponent(q)}`;
    };
    document.getElementById('pageSize').onchange = (e)=>{
      pageSize = parseInt(e.target.value,10)||1000; pageIndex=0; render();
    };
    document.getElementById('refresh').onclick = ()=> loadAll(true);

    supa.channel('realtime:players')
      .on('postgres_changes',{event:'*',schema:'public',table:'players'}, ()=>{
        const btn=document.getElementById('refresh');
        btn.classList.remove('hidden'); btn.textContent='Refresh data';
      }).subscribe();

    // Load data + premium markers (re-render after premium list arrives)
    loadAll();
    loadRecent();
    initPremium().then(()=> render());
  </script>

  <!-- Auth bar (Discord) -->
  <script>
    (async () => {
      try {
        const client = (typeof supa !== 'undefined')
          ? supa
          : supabase.createClient(SUPA_URL, SUPA_ANON);

        const host = document.getElementById('authbar');
        if (!host) return;

        const { data: { user } } = await client.auth.getUser();

        if (!user) {
          host.innerHTML = `
            <div class="flex items-center justify-end">
              <button id="btnDiscord"
                      class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm">
                Sign in with Discord
              </button>
            </div>`;
          document.getElementById('btnDiscord').onclick = () =>
            client.auth.signInWithOAuth({
              provider: 'discord',
              options: { redirectTo: location.href }
            });
          return;
        }

        const username = user.user_metadata?.name
                      || user.user_metadata?.full_name
                      || 'Account';

        host.innerHTML = `
          <div class="flex items-center justify-end gap-2">
            <span class="text-sm text-slate-300">${username}</span>
            <a href="account.html"
               class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">
              Account
            </a>
            <button id="btnSignout"
                    class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">
              Sign out
            </button>
          </div>`;
        document.getElementById('btnSignout').onclick = async () => {
          await client.auth.signOut();
          location.reload();
        };
      } catch (e) {
        console.error('[authbar]', e);
      }
    })();
  </script>

</body>
</html>
