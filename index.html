<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CG Ranked Live</title>
  <style>
    html,body{margin:0;padding:0;font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#eef}
    header{position:sticky;top:0;background:#0f172a;border-bottom:1px solid #223;display:flex;gap:16px;align-items:center;padding:12px 16px}
    .brand{font-weight:700;letter-spacing:.5px}
    .container{max-width:1100px;margin:0 auto;padding:16px}
    .card{background:#0f172a;border:1px solid #223;border-radius:12px;padding:16px;margin-bottom:16px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 8px;border-bottom:1px solid #1d283a;font-variant-numeric:tabular-nums}
    th{text-align:left;color:#9fb3c8;font-weight:600}
    tr:hover td{background:#0d1426}
    a{color:#80b3ff;text-decoration:none}
    .muted{color:#a7b4c8}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3b57;background:#0c1324}
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
</head>
<body>
  <header>
    <div class="brand">CG Ranked Live</div>
    <div class="muted">Live leaderboard & player pages (auto-refresh)</div>
  </header>

  <main class="container">
    <section class="card">
      <h2>Leaderboard</h2>
      <div id="leaderboard-status" class="muted">Loading…</div>
      <div style="overflow:auto">
        <table id="leaderboard">
          <thead>
            <tr>
              <th>#</th><th>Player</th><th>Rank</th><th>Elo</th><th>RP</th><th>Games</th><th>Win%</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>Recent Matches</h2>
      <div id="matches-status" class="muted">Loading…</div>
      <div style="overflow:auto">
        <table id="matches">
          <thead>
            <tr>
              <th>When</th><th>P1</th><th>P2</th><th>Score</th><th>Winner</th><th>Map</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </main>

<script>
const SUPABASE_URL  = "https://qnxjrkedbplfrlkjqifh.supabase.co";
const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFueGpya2VkYnBsZnJsa2pxaWZoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIwMzU2ODMsImV4cCI6MjA3NzYxMTY4M30.WhFaUXjM7i0c4b-R5MHrs67R_xdTBp7d82OI62x4G9M";

const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

function el(tag, attrs={}, ...children){
  const e = document.createElement(tag);
  for(const [k,v] of Object.entries(attrs)){ if(k==='class') e.className=v; else e.setAttribute(k,v);}
  for(const c of children){
    if(c==null) continue;
    e.appendChild(c.nodeType?c:document.createTextNode(c));
  }
  return e;
}

function fmtPct(wins, games){ if(!games) return '0%'; return Math.round(wins*100/games)+'%'; }

async function loadLeaderboard(){
  const s = document.getElementById('leaderboard-status');
  const tb = document.querySelector('#leaderboard tbody');
  s.textContent = 'Loading…';
  tb.innerHTML = '';

  const { data, error } = await sb
    .from('players')
    .select('*')
    .order('elo', { ascending:false })
    .limit(100);

  if(error){ s.textContent = 'Error: '+error.message; return; }
  if(!data || !data.length){ s.textContent='No data yet.'; return; }
  s.textContent = '';

  data.forEach((row, idx)=>{
    const link = el('a', { href: './player.html?sid='+encodeURIComponent(row.steam_id) }, row.username || row.steam_id);
    const tr = el('tr',{},
      el('td',{}, String(idx+1)),
      el('td',{}, link),
      el('td',{}, row.rank || ''),
      el('td',{}, row.elo==null?'':String(row.elo)),
      el('td',{}, row.rp==null?'':String(row.rp)),
      el('td',{}, row.games_played==null?'':String(row.games_played)),
      el('td',{}, fmtPct(row.wins||0, row.games_played||0))
    );
    tb.appendChild(tr);
  });
}

async function loadMatches(){
  const s = document.getElementById('matches-status');
  const tb = document.querySelector('#matches tbody');
  s.textContent = 'Loading…';
  tb.innerHTML = '';

  const { data, error } = await sb
    .from('matches')
    .select('*')
    .order('played_at', { ascending:false })
    .limit(50);

  if(error){ s.textContent = 'Error: '+error.message; return; }
  if(!data || !data.length){ s.textContent = 'No matches yet.'; return; }
  s.textContent = '';

  data.forEach(m=>{
    const tr = el('tr',{},
      el('td',{}, new Date(m.played_at).toLocaleString()),
      el('td',{}, m.p1_id),
      el('td',{}, m.p2_id),
      el('td',{}, (m.p1_score??'-')+'–'+(m.p2_score??'-')),
      el('td',{}, m.winner_id || '-'),
      el('td',{}, String(m.map_id ?? ''))
    );
    tb.appendChild(tr);
  });
}

async function init(){
  await Promise.all([loadLeaderboard(), loadMatches()]);

  // Realtime refresh (optional if you've added publication)
  try {
    sb.channel('public:players').on('postgres_changes', { event: '*', schema: 'public', table: 'players' }, loadLeaderboard).subscribe();
    sb.channel('public:matches').on('postgres_changes', { event: '*', schema: 'public', table: 'matches' }, loadMatches).subscribe();
  } catch (_e) {}
}

init();
</script>
</body>
</html>
