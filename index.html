<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ranked Tag ‚Äî Leaderboard</title>

  <!-- UI + Supabase -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚ö†Ô∏è Set your Supabase public values -->
  <script>
    window.SUPA_URL  = "https://YOUR_SUPABASE_URL.supabase.co";
    window.SUPA_ANON = "YOUR_SUPABASE_ANON_KEY";
  </script>
</head>
<body class="bg-slate-950 text-slate-100">

  <!-- Auth bar (added) -->
  <div class="max-w-6xl mx-auto p-4">
    <div id="authbar" class="mb-3"></div>
  </div>

  <!-- ======== your existing page content starts here (unchanged) ======== -->
  <!-- If tu avais d√©j√† du contenu, garde-le. Ci-dessous un squelette courant. -->
  <div class="max-w-6xl mx-auto p-4">
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
      <h1 class="text-2xl font-bold">üèÜ Ranked Tag ‚Äî Live Leaderboard</h1>
      <div class="flex items-center gap-2">
        <input id="search" class="px-3 py-2 rounded bg-slate-800 border border-slate-700" placeholder="Search username or SteamID" />
        <button id="go" class="px-3 py-2 rounded bg-indigo-600 hover:bg-indigo-500">Search</button>
      </div>
    </header>

    <section class="mb-3 flex flex-col md:flex-row md:items-center md:justify-between gap-2">
      <div class="flex items-center gap-3">
        <span id="status" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm">Loading‚Ä¶</span>
        <label class="text-sm text-slate-400">Page size</label>
        <select id="pageSize" class="bg-slate-900 border border-slate-800 rounded px-2 py-1">
          <option>100</option><option>250</option><option>500</option><option selected>1000</option>
        </select>
        <button id="refresh" class="hidden px-3 py-1.5 rounded bg-emerald-600 hover:bg-emerald-500 text-sm">Refresh data</button>
      </div>
      <div id="pager" class="flex items-center gap-2 text-sm"></div>
    </section>

    <section>
      <div id="board" class="overflow-x-auto border border-slate-800 rounded"></div>
    </section>

    <section class="mt-10">
      <h2 class="text-xl font-semibold mb-2">Recent Matches</h2>
      <div id="recent" class="grid md:grid-cols-2 gap-3"></div>
    </section>
  </div>
  <!-- ======== your existing page content ends here ======== -->

  <!-- Minimal logic pour la barre d‚Äôauth (inline pour ne pas ajouter de fichier JS) -->
  <script>
    const supa = supabase.createClient(window.SUPA_URL, window.SUPA_ANON);

    async function renderAuthBar() {
      const host = document.getElementById('authbar');
      if (!host) return;
      const { data:{ user } } = await supa.auth.getUser();

      if (!user) {
        host.innerHTML = `
          <div class="flex items-center justify-end">
            <button id="signin" class="px-3 py-1.5 rounded bg-indigo-600 hover:bg-indigo-500 text-white text-sm">
              Sign in with Discord
            </button>
          </div>`;
        document.getElementById('signin').onclick = () =>
          supa.auth.signInWithOAuth({
            provider: 'discord',
            options: { redirectTo: location.href }
          });
        return;
      }

      // Try to read profile (optional)
      let username = 'Account';
      try {
        const { data: p } = await supa.from('profiles').select('username,premium_until').eq('user_id', user.id).maybeSingle();
        username = p?.username || user.user_metadata?.full_name || user.user_metadata?.name || 'Account';
        const badge = (p?.premium_until && new Date(p.premium_until) > new Date())
          ? `<span class="ml-2 px-2 py-0.5 rounded-full text-xs bg-amber-500/15 border border-amber-400/40 text-amber-300">Premium</span>`
          : '';
        host.innerHTML = `
          <div class="flex items-center justify-end gap-2">
            <span class="text-sm text-slate-300">${username}</span>
            ${badge}
            <a href="account.html" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">Account</a>
            <button id="signout" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">Sign out</button>
          </div>`;
      } catch {
        host.innerHTML = `
          <div class="flex items-center justify-end gap-2">
            <span class="text-sm text-slate-300">${username}</span>
            <a href="account.html" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">Account</a>
            <button id="signout" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 text-sm hover:bg-slate-700">Sign out</button>
          </div>`;
      }

      document.getElementById('signout').onclick = async () => { await supa.auth.signOut(); location.reload(); };
    }
    document.addEventListener('DOMContentLoaded', renderAuthBar);
  </script>

  <!-- Ton JS existant pour le leaderboard peut rester tel quel.
       Si tu veux, garde ta logique actuelle ; ci-dessous, des handlers
       tr√®s basiques pour √©viter erreurs si tu gardes ce squelette. -->
  <script>
    const SUPA_URL  = window.SUPA_URL;
    const SUPA_ANON = window.SUPA_ANON;
    const client = supabase.createClient(SUPA_URL, SUPA_ANON);

    function esc(s){return (s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
    function tierOrder(rank){const r=(rank||'').toLowerCase();if(r.startsWith('chall'))return 9;if(r.startsWith('gm'))return 8;if(r.startsWith('master'))return 7;if(r.startsWith('diamond'))return 6;if(r.startsWith('platinum'))return 5;if(r.startsWith('gold'))return 4;if(r.startsWith('silver'))return 3;if(r.startsWith('bronze'))return 2;if(r.startsWith('clown'))return 1;return 0;}
    function divFromRank(rank){const last=(rank||'').trim().split(/\s+/).pop().toUpperCase();const map={I:1,II:2,III:3,IV:4};return map[last]||4;}

    let pageSize=1000,pageIndex=0,total=0,rows=[],sorted=[],sort={key:'rank',dir:'desc'};

    function header(label,key){const arrow=sort.key===key?(sort.dir==='asc'?' ‚ñ≤':' ‚ñº'):'';return `<th class="p-2 text-left select-none cursor-pointer" data-sort="${key}">${label}${arrow}</th>`;}
    function applySort(a){const k=sort.key,dir=sort.dir;const s=v=>v??-Infinity;a.sort((A,B)=>{if(k==='rank'){const t=tierOrder(B.rank)-tierOrder(A.rank);if(t)return t;const d=divFromRank(A.rank)-divFromRank(B.rank);if(d)return d;const r=(B.rp??0)-(A.rp??0);if(r)return r;return (B.elo??0)-(A.elo??0);}if(k==='player')return (A.username||'').localeCompare(B.username||'',undefined,{sensitivity:'base'});if(k==='rp')return s(B.rp)-s(A.rp);if(k==='elo')return s(B.elo)-s(A.elo);if(k==='games')return s(B.games)-s(A.games);if(k==='wr')return s(B.win_rate)-s(A.win_rate);return 0;});if(dir==='asc')a.reverse();a.forEach((r,i)=>r.__pos=i+1);return a;}

    function renderTable(slice){
      const thead = `<thead class="bg-slate-900"><tr>
        ${header('#','rank')}${header('Player','player')}${header('Rank','rank')}
        ${header('RP','rp')}${header('Elo','elo')}${header('Games','games')}${header('Win%','wr')}
      </tr></thead>`;
      const body = slice.map(r=>`
        <tr class="border-t border-slate-800 hover:bg-slate-900">
          <td class="p-2">${r.__pos}</td>
          <td class="p-2"><a class="text-indigo-400 hover:underline" href="player.html?steam_id=${encodeURIComponent(r.steam_id)}">${esc(r.username||r.steam_id)}</a></td>
          <td class="p-2 text-center">${esc(r.rank||'')}</td>
          <td class="p-2 text-center">${r.rp??''}</td>
          <td class="p-2 text-center">${r.elo??''}</td>
          <td class="p-2 text-center">${r.games??0}</td>
          <td class="p-2 text-center">${r.win_rate??0}</td>
        </tr>`).join('');
      document.getElementById('board').innerHTML = `<table class="w-full text-sm">${thead}<tbody>${body}</tbody></table>`;
      document.querySelectorAll('[data-sort]').forEach(th=>{
        th.onclick=()=>{const k=th.getAttribute('data-sort');if(sort.key===k)sort.dir=sort.dir==='asc'?'desc':'asc';else{sort.key=k;sort.dir=(k==='player'?'asc':'desc');}sorted=applySort([...rows]);pageIndex=0;render();};
      });
    }
    function renderPager(){
      const pages=Math.max(1,Math.ceil(total/pageSize));
      const el=document.getElementById('pager');
      el.innerHTML = `
        <button id="first" class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex<=0?'opacity-50':''}">¬´ First</button>
        <button id="prev"  class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex<=0?'opacity-50':''}">‚Äπ Prev</button>
        <span class="text-slate-300">Page <b>${pageIndex+1}</b> / ${pages} ¬∑ Total <b>${total}</b></span>
        <button id="next"  class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex>=pages-1?'opacity-50':''}">Next ‚Ä∫</button>
        <button id="last"  class="px-2 py-1 rounded bg-slate-800 border border-slate-700 ${pageIndex>=pages-1?'opacity-50':''}">Last ¬ª</button>`;
      document.getElementById('first').onclick=()=>{pageIndex=0;render();};
      document.getElementById('prev').onclick =()=>{if(pageIndex>0){pageIndex--;render();}};
      document.getElementById('next').onclick =()=>{const p=Math.ceil(total/pageSize);if(pageIndex<p-1){pageIndex++;render();}};
      document.getElementById('last').onclick =()=>{pageIndex=Math.ceil(total/pageSize)-1;render();};
    }
    function render(){const start=pageIndex*pageSize,end=start+pageSize;renderTable(sorted.slice(start,end));renderPager();}

    async function loadAll(reload=false){
      document.getElementById('status').textContent= reload ? 'Refreshing‚Ä¶':'Loading‚Ä¶';
      const { count } = await client.from('view_leaderboard').select('steam_id',{count:'exact',head:false}).range(0,0);
      total=count||0;
      const step=1000,pages=Math.ceil(total/step),acc=[];
      for(let i=0;i<pages;i++){const a=i*step,b=a+step-1;const { data } = await client.from('view_leaderboard').select('steam_id,username,rank,elo,rp,games,wins,win_rate').range(a,b);acc.push(...(data||[]));document.getElementById('status').textContent=`Loaded ${Math.min(b+1,total)}/${total}`;}
      rows=acc;sorted=applySort([...rows]);pageIndex=0;document.getElementById('status').textContent=`Ready ¬∑ ${total} players`;render();
    }
    async function loadRecent(){
      const { data } = await client.from('matches').select('id,played_at,p1_name,p2_name,winner,map_id').order('played_at',{ascending:false}).limit(20);
      const cont=document.getElementById('recent');cont.innerHTML='';
      for(const m of (data||[])){
        const w=m.winner==='1'?(m.p1_name||'P1'):m.winner==='2'?(m.p2_name||'P2'):'‚Äî';
        cont.innerHTML += `<a href="match.html?id=${m.id}" class="block p-3 rounded border border-slate-800 hover:border-indigo-500">
          <div class="text-slate-300 text-sm">${new Date(m.played_at).toLocaleString()}</div>
          <div class="font-semibold">${esc(m.p1_name||'P1')} vs ${esc(m.p2_name||'P2')}</div>
          <div class="text-slate-400 text-sm">Winner: <span class="text-slate-100">${esc(w)}</span> ¬∑ Map ${m.map_id??'-'}</div>
        </a>`;
      }
    }
    document.getElementById('go').onclick = ()=>{const q=document.getElementById('search').value.trim();if(!q)return;location.href=`player.html?q=${encodeURIComponent(q)}`;};
    document.getElementById('pageSize').onchange=(e)=>{pageSize=parseInt(e.target.value,10)||1000;pageIndex=0;render();};
    document.getElementById('refresh').onclick=()=>loadAll(true);
    client.channel('realtime:players').on('postgres_changes',{event:'*',schema:'public',table:'players'},()=>{const b=document.getElementById('refresh');b.classList.remove('hidden');b.textContent='Refresh data';}).subscribe();
    loadAll(); loadRecent();
  </script>
</body>
</html>
