<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Match</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Minimal dark styles to match your existing theme -->
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#8ea3c2; --text:#e8f0ff; --primary:#6c63ff; --border:#24314d; }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    a{color:#9fb4ff;text-decoration:none}
    .container{max-width:980px;margin:24px auto;padding:0 16px}
    .back{display:inline-block;margin-bottom:8px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px}
    .muted{color:var(--muted)}
    .row{display:grid;gap:12px}
    .row.cols-2{grid-template-columns:1fr 1fr}
    .row.cols-3{grid-template-columns:1fr 1fr 1fr}
    .row.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}
    .btn{background:var(--primary);border:0;color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .tag{display:inline-block;background:#0f1a34;border:1px solid var(--border);padding:2px 8px;border-radius:999px;color:#cbd7ff;font-size:12px}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
    .grid.cols-4{grid-template-columns:repeat(4,1fr)}
    .imgCard{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:8px}
    .imgCard img{display:block;width:100%;height:auto;border-radius:6px}
    .header-line{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1a34;color:#dfe7ff}
    .h1{font-size:18px;font-weight:700;margin:0 0 6px}
    .h2{font-size:15px;font-weight:700;margin:0 0 10px}
    .kv{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .kv .item{background:#0f1a34;border:1px solid var(--border);border-radius:8px;padding:10px}
    .kv .k{font-size:12px;color:#a5b7d8;margin-bottom:4px}
    .kv .v{font-weight:700}
    .spacer{height:12px}
    .center{display:flex;justify-content:center;align-items:center}
  </style>
</head>
<body>
  <div class="container">
    <a class="back" href="index.html">← Back</a>

    <div id="matchBox" class="card" style="margin-bottom:12px">
      <div class="muted">Loading…</div>
    </div>

    <div id="analysisBox" class="card">
      <div class="header-line">
        <div>
          <div class="h2">Game Analysis</div>
          <div id="analysisMeta" class="muted"></div>
        </div>
        <button id="analyzeBtn" class="btn">Analyze game</button>
      </div>

      <div id="qualityCards" class="row cols-2" style="margin-top:12px; display:none">
        <div class="card" id="p1Card">
          <div class="h2" id="p1Title">P1 — Quality</div>
          <div class="kv">
            <div class="item"><div class="k">Quality</div><div class="v" id="p1Qual">-</div></div>
            <div class="item"><div class="k">Possession</div><div class="v" id="p1Pos">-</div></div>
            <div class="item"><div class="k">Accuracy</div><div class="v" id="p1Acc">-</div></div>
            <div class="item"><div class="k">Avg dist (hider)</div><div class="v" id="p1DistH">-</div></div>
            <div class="item"><div class="k">Avg dist (tagger)</div><div class="v" id="p1DistT">-</div></div>
            <div class="item"><div class="k">Retag median</div><div class="v" id="p1Retag">-</div></div>
            <div class="item"><div class="k">Avg speed</div><div class="v" id="p1Speed">-</div></div>
          </div>
        </div>

        <div class="card" id="p2Card">
          <div class="h2" id="p2Title">P2 — Quality</div>
          <div class="kv">
            <div class="item"><div class="k">Quality</div><div class="v" id="p2Qual">-</div></div>
            <div class="item"><div class="k">Possession</div><div class="v" id="p2Pos">-</div></div>
            <div class="item"><div class="k">Accuracy</div><div class="v" id="p2Acc">-</div></div>
            <div class="item"><div class="k">Avg dist (hider)</div><div class="v" id="p2DistH">-</div></div>
            <div class="item"><div class="k">Avg dist (tagger)</div><div class="v" id="p2DistT">-</div></div>
            <div class="item"><div class="k">Retag median</div><div class="v" id="p2Retag">-</div></div>
            <div class="item"><div class="k">Avg speed</div><div class="v" id="p2Speed">-</div></div>
          </div>
        </div>
      </div>

      <div class="spacer"></div>

      <div>
        <div class="h2">Visuals</div>
        <div id="images-grid" class="grid cols-3">
          <div class="muted">No images produced.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---- Config loader: window → localStorage → query params
    function getConfig(){
      const qp = new URLSearchParams(location.search);
      const url = window.SUPABASE_URL || localStorage.getItem('SUPABASE_URL') || qp.get('supabase_url') || '';
      const key = window.SUPABASE_ANON_KEY || localStorage.getItem('SUPABASE_ANON_KEY') || qp.get('supabase_key') || '';
      if(!url || !key){ console.warn('Supabase config not found. Provide window.SUPABASE_URL & window.SUPABASE_ANON_KEY or set them in localStorage.'); }
      return { url: url.replace(/\/$/,''), key };
    }
    const CFG = getConfig();
    const REST = CFG.url + '/rest/v1';
    const HEADERS_JSON = {
      'apikey': CFG.key,
      'Authorization': 'Bearer ' + CFG.key,
      'Content-Type': 'application/json'
    };

    const qs = new URLSearchParams(location.search);
    const MATCH_ID = qs.get('id');

    const elMatch = document.getElementById('matchBox');
    const elAnalyze = document.getElementById('analyzeBtn');
    const elAnalysisMeta = document.getElementById('analysisMeta');
    const elImages = document.getElementById('images-grid');
    const elQualityRow = document.getElementById('qualityCards');

    const elP1Title = document.getElementById('p1Title');
    const elP2Title = document.getElementById('p2Title');
    const elP1Qual  = document.getElementById('p1Qual');
    const elP2Qual  = document.getElementById('p2Qual');
    const elP1Pos   = document.getElementById('p1Pos');
    const elP2Pos   = document.getElementById('p2Pos');
    const elP1Acc   = document.getElementById('p1Acc');
    const elP2Acc   = document.getElementById('p2Acc');
    const elP1DistH = document.getElementById('p1DistH');
    const elP2DistH = document.getElementById('p2DistH');
    const elP1DistT = document.getElementById('p1DistT');
    const elP2DistT = document.getElementById('p2DistT');
    const elP1Retag = document.getElementById('p1Retag');
    const elP2Retag = document.getElementById('p2Retag');
    const elP1Speed = document.getElementById('p1Speed');
    const elP2Speed = document.getElementById('p2Speed');

    function fmtPct(x){ return (x==null)?'—':(Math.round(x*1000)/10)+'%'; }
    function fmtNum(x){ return (x==null)?'—':(Math.round(x*10)/10); }
    function fmtMs(x){ return (x==null)?'—':(Math.round(x*100)/100)+' s'; }
    function fmtM(x){ return (x==null)?'—':(Math.round(x*100)/100)+' m'; }
    function fmtMspeed(x){ return (x==null)?'—':(Math.round(x*100)/100)+' m/s'; }

    async function fetchJSON(url, params){
      const u = new URL(url);
      if (params) for (const [k,v] of Object.entries(params)) u.searchParams.set(k,v);
      const r = await fetch(u.toString(), { headers: HEADERS_JSON });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    async function postJSON(url, body){
      const r = await fetch(url, { method:'POST', headers: HEADERS_JSON, body: JSON.stringify(body) });
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }

    function parseImagesField(analysis){
      const raw = analysis?.images ?? analysis?.summary?.images ?? [];
      if (Array.isArray(raw)) return raw.filter(u => typeof u === 'string');
      if (typeof raw === 'string'){
        try { const arr = JSON.parse(raw); return Array.isArray(arr)?arr.filter(u => typeof u === 'string'):[]; }
        catch { return []; }
      }
      return [];
    }

    function renderImages(analysis){
      const images = parseImagesField(analysis);
      elImages.innerHTML = '';
      if (!images.length){
        const div = document.createElement('div');
        div.className = 'muted';
        div.textContent = 'No images produced.';
        elImages.appendChild(div);
        return;
      }
      const toShow = images.slice(0, 12);
      for (const url of toShow){
        const box = document.createElement('div');
        box.className = 'imgCard';
        const img = document.createElement('img');
        img.src = url; img.alt = 'analysis';
        img.loading = 'lazy';
        box.appendChild(img);
        elImages.appendChild(box);
      }
      if (images.length > toShow.length){
        const more = document.createElement('div');
        more.className = 'muted';
        more.textContent = `+${images.length - toShow.length} more…`;
        elImages.appendChild(more);
      }
    }

    function renderMatchHeader(m){
      const when = m.played_at ? new Date(m.played_at).toLocaleString() : '';
      const p1 = `${m.p1_name || 'P1'} ${m.p1_elo_after ? '('+m.p1_elo_after+')' : ''}`.trim();
      const p2 = `${m.p2_name || 'P2'} ${m.p2_elo_after ? '('+m.p2_elo_after+')' : ''}`.trim();

      elMatch.innerHTML = `
        <div class="muted">${when}</div>
        <div class="h1"><a href="player.html?steam_id=${encodeURIComponent(m.p1_id)}">${p1}</a> vs <a href="player.html?steam_id=${encodeURIComponent(m.p2_id)}">${p2}</a></div>
        <div style="margin:8px 0 12px" class="muted">Winner: <span class="pill">${m.winner === 1 ? (m.p1_name || 'P1') : (m.p2_name || 'P2')}</span> • Map ${m.map_id ?? '-'}</div>
        <div><a class="btn" href="${m.replay_url || '#'}" download>Download replay</a></div>
      `;
    }

    function renderAnalysis(a, fallbackNames){
      const p1n = a.p1_name || fallbackNames.p1 || 'P1';
      const p2n = a.p2_name || fallbackNames.p2 || 'P2';
      elP1Title.textContent = `${p1n} — Quality`;
      elP2Title.textContent = `${p2n} — Quality`;

      elAnalysisMeta.textContent = a.analyzed_at ? `Analyzed at ${new Date(a.analyzed_at).toLocaleString()} (${a.version||'v?'})` : '';

      elP1Qual.textContent = a.p1_quality!=null ? a.p1_quality : '—';
      elP2Qual.textContent = a.p2_quality!=null ? a.p2_quality : '—';

      const s1 = a.p1_stats || {};
      const s2 = a.p2_stats || {};

      elP1Pos.textContent   = fmtPct(s1.possession_share);
      elP2Pos.textContent   = fmtPct(s2.possession_share);
      // Accuracy si dispo, sinon “—”
      elP1Acc.textContent   = (s1.accuracy!=null)?fmtPct(s1.accuracy):'—';
      elP2Acc.textContent   = (s2.accuracy!=null)?fmtPct(s2.accuracy):'—';

      elP1DistH.textContent = fmtM(s1.avg_distance_as_hider);
      elP2DistH.textContent = fmtM(s2.avg_distance_as_hider);
      elP1DistT.textContent = fmtM(s1.avg_distance_as_tagger);
      elP2DistT.textContent = fmtM(s2.avg_distance_as_tagger);

      elP1Retag.textContent = fmtMs(s1.retag_median);
      elP2Retag.textContent = fmtMs(s2.retag_median);

      elP1Speed.textContent = fmtMspeed(s1.avg_speed);
      elP2Speed.textContent = fmtMspeed(s2.avg_speed);

      elQualityRow.style.display = 'grid';
      renderImages(a);
    }

    async function loadAll(){
      if (!MATCH_ID){
        elMatch.innerHTML = `<div class="muted">Match ID missing.</div>`;
        elAnalyze.disabled = true;
        return;
      }
      // 1) match
      const matchRows = await fetchJSON(`${REST}/matches`, {
        id: `eq.${MATCH_ID}`,
        select: [
          'id','played_at','winner','map_id','replay_url',
          'p1_id','p1_name','p1_elo_before','p1_elo_after',
          'p2_id','p2_name','p2_elo_before','p2_elo_after'
        ].join(',')
      });
      if (!matchRows.length){
        elMatch.innerHTML = `<div class="muted">Match not found.</div>`;
        return;
      }
      const match = matchRows[0];
      renderMatchHeader(match);

      // 2) analysis (if exists)
      const aRows = await fetchJSON(`${REST}/match_analyses`, {
        match_id: `eq.${MATCH_ID}`,
        select: '*'
      });
      if (aRows.length){
        renderAnalysis(aRows[0], { p1: match.p1_name, p2: match.p2_name });
      } else {
        elAnalysisMeta.textContent = 'No analysis yet.';
        elImages.innerHTML = `<div class="muted">No images produced.</div>`;
      }

      // 3) wire analyze button
      elAnalyze.onclick = async () => {
        try{
          elAnalyze.disabled = true;
          elAnalyze.textContent = 'Queued…';
          await postJSON(`${REST}/analysis_requests`, [{
            match_id: match.id,
            replay_url: match.replay_url || null,
            requested_by: 'web',
            status: 'queued'
          }]);
          elAnalysisMeta.textContent = 'Analysis queued. Waiting for result…';
          // Poll until analysis exists
          const started = Date.now();
          const poll = setInterval(async () => {
            try{
              const rows = await fetchJSON(`${REST}/match_analyses`, {
                match_id: `eq.${MATCH_ID}`,
                select: '*'
              });
              if (rows.length){
                clearInterval(poll);
                renderAnalysis(rows[0], { p1: match.p1_name, p2: match.p2_name });
                elAnalyze.disabled = false;
                elAnalyze.textContent = 'Analyze game';
              } else if (Date.now() - started > 180000) {
                clearInterval(poll);
                elAnalysisMeta.textContent = 'Timed out waiting for analysis.';
                elAnalyze.disabled = false;
                elAnalyze.textContent = 'Analyze game';
              }
            }catch(e){ /* ignore while waiting */ }
          }, 3000);
        }catch(err){
          console.error(err);
          alert('Failed to queue analysis: ' + err.message);
          elAnalyze.disabled = false;
          elAnalyze.textContent = 'Analyze game';
        }
      };
    }

    // bootstrap
    loadAll().catch(e=>{
      console.error(e);
      elMatch.innerHTML = `<div class="muted">Failed to load match.</div>`;
    });
  </script>
</body>
</html>
